// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: reactions.sql

package database

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"
)

const deleteOldStats = `-- name: DeleteOldStats :exec
DELETE from posts_reactions_history
where synced_at < now() - INTERVAL '14 days'
`

func (q *Queries) DeleteOldStats(ctx context.Context) error {
	_, err := q.db.ExecContext(ctx, deleteOldStats)
	return err
}

const getDailyStats = `-- name: GetDailyStats :many
SELECT 
        s.id, s.network, s.user_name, DATE(p.created_at) as date,
        SUM(prh.likes) as total_likes,
        SUM(prh.reposts) as total_reposts,
        SUM(prh.views) as total_views
 
    FROM posts_reactions_history prh
        JOIN posts p ON prh.post_id = p.id
        JOIN sources s ON p.source_id = s.id

    WHERE s.user_id = $1
    AND prh.synced_at = (
        SELECT MAX(synced_at) 
        FROM posts_reactions_history 
        WHERE post_id = prh.post_id 
        AND DATE(synced_at) = DATE(prh.synced_at)
    )
    AND p.post_type <> 'repost'

GROUP BY s.id, s.network, s.user_name, DATE(prh.synced_at), DATE(p.created_at)
ORDER BY s.id, date ASC
`

type GetDailyStatsRow struct {
	ID           uuid.UUID
	Network      string
	UserName     string
	Date         time.Time
	TotalLikes   int64
	TotalReposts int64
	TotalViews   int64
}

func (q *Queries) GetDailyStats(ctx context.Context, userID uuid.UUID) ([]GetDailyStatsRow, error) {
	rows, err := q.db.QueryContext(ctx, getDailyStats, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetDailyStatsRow
	for rows.Next() {
		var i GetDailyStatsRow
		if err := rows.Scan(
			&i.ID,
			&i.Network,
			&i.UserName,
			&i.Date,
			&i.TotalLikes,
			&i.TotalReposts,
			&i.TotalViews,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const syncReactions = `-- name: SyncReactions :one
INSERT INTO posts_reactions_history (id, synced_at, post_id, likes, reposts, views)
VALUES (
    $1,
    $2,
    $3,
    $4,
    $5,
    $6
)
RETURNING id, synced_at, post_id, likes, reposts, views
`

type SyncReactionsParams struct {
	ID       uuid.UUID
	SyncedAt time.Time
	PostID   uuid.UUID
	Likes    sql.NullInt32
	Reposts  sql.NullInt32
	Views    sql.NullInt32
}

func (q *Queries) SyncReactions(ctx context.Context, arg SyncReactionsParams) (PostsReactionsHistory, error) {
	row := q.db.QueryRowContext(ctx, syncReactions,
		arg.ID,
		arg.SyncedAt,
		arg.PostID,
		arg.Likes,
		arg.Reposts,
		arg.Views,
	)
	var i PostsReactionsHistory
	err := row.Scan(
		&i.ID,
		&i.SyncedAt,
		&i.PostID,
		&i.Likes,
		&i.Reposts,
		&i.Views,
	)
	return i, err
}
