{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <div>
        <h1>Sources</h1>
    </div>

    <div class="flex gap-2">
        <form method="GET" action="/sources">
            <button class="btn btn-secondary btn-icon" title="Refresh">
                <i data-lucide="refresh-cw"></i> Refresh
            </button>
        </form>

    </div>
</div>

<div class="grid-responsive">
    <div>
        <div class="card">
            <div class="card-header">Add New Source</div>
            <form method="POST" action="/sources/setup" id="source_form" autocomplete="off">
                <input type="hidden" name="user_id" value="{{.user_id}}">

                <div class="form-group">
                    <label class="form-label" for="network">Network</label>
                    <select id="network" name="network" class="form-select" required>
                        <option value="" disabled selected>Select Network</option>
                        {{range .available_sources}}
                        <option value="{{.Name}}">{{.Name}}</option>
                        {{end}}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="username_input">Username</label>
                    <input type="text" id="username_input" name="username" class="form-input"
                        placeholder="username (no @)" required autocapitalize="off">
                </div>

                <div class="form-group" id="instagram_section" style="display:none;">
                    <label class="form-label" for="instagram_profile_id">Instagram Profile ID</label>
                    <input id="instagram_profile_id" name="instagram_profile_id" class="form-input"
                        placeholder="123456789" autocapitalize="off">

                    <label class="form-label" for="app_id">App ID</label>
                    <input id="app_id" name="app_id" class="form-input" placeholder="Facebook App ID"
                        autocapitalize="off">

                    <label class="form-label" for="app_secret">App Secret</label>
                    <input id="app_secret" name="app_secret" type="password" class="form-input"
                        placeholder="Facebook App Secret" autocapitalize="off">
                </div>

                <div class="form-group" id="google_analytics_section" style="display:none;">
                    <label class="form-label" for="google_analytics_property_id">Property ID</label>
                    <input id="google_analytics_property_id" name="google_analytics_property_id" class="form-input"
                        placeholder="e.g. 34221144" autocapitalize="off">
                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Found in Admin > Property
                        Settings</p>

                    <label class="form-label" for="google_service_account_key">Service Account JSON Key</label>
                    <textarea id="google_service_account_key" name="google_service_account_key" class="form-input"
                        rows="5" placeholder='{"type": "service_account", ...}' autocapitalize="off"></textarea>
                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Create a Service Account in
                        Google Cloud
                        Console, download the JSON key, and paste it here.</p>
                </div>

                <div class="form-group" id="telegram_section" style="display:none;">

                    <label class="form-label" for="telegram_bot_token">Telegram Bot Token</label>
                    <input id="telegram_bot_token" name="telegram_bot_token" class="form-input"
                        placeholder="your_bot-token" autocapitalize="off">

                    <label class="form-label" for="telegram_channel_id">Telegram Channel ID</label>
                    <input id="telegram_channel_id" name="telegram_channel_id" class="form-input"
                        placeholder="your_channel_id" autocapitalize="off">

                    <label class="form-label" for="telegram_app_id">Telegram App ID</label>
                    <input id="telegram_app_id" name="telegram_app_id" class="form-input" placeholder="your_app_id"
                        autocapitalize="off">

                    <label class="form-label" for="telegram_app_hash">Telegram App Hash</label>
                    <input id="telegram_app_hash" name="telegram_app_hash" class="form-input"
                        placeholder="your_app_hash" autocapitalize="off">

                </div>

                <div class="form-group" id="discord_section" style="display:none;">
                    <label class="form-label" for="discord_bot_token">Discord Bot Token</label>
                    <input id="discord_bot_token" name="discord_bot_token" class="form-input"
                        placeholder="your_bot_token" autocapitalize="off">

                    <label class="form-label" for="discord_server_id">Server ID</label>
                    <input id="discord_server_id" name="discord_server_id" class="form-input" placeholder="123456789"
                        autocapitalize="off">

                    <label class="form-label" for="discord_channel_ids">Channel IDs (comma-separated)</label>
                    <input id="discord_channel_ids" name="discord_channel_ids" class="form-input"
                        placeholder="123456,789012,345678" autocapitalize="off">
                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Enter multiple channel IDs
                        separated by commas</p>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i data-lucide="plus"></i> Add Source
                </button>
            </form>
        </div>
    </div>

    <div>
        <div class="card">
            <div class="card-header">User Sources</div>

            {{if not .sources}}
            <div class="text-center" style="padding: 2rem; color: var(--color-text-muted);">
                <i data-lucide="ghost" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                <p>No sources connected yet.</p>
            </div>
            {{else}}
            <div class="flex flex-col gap-2">
                {{range .sources}}
                <div class="source-item">
                    <div class="source-info">
                        <div class="flex items-center gap-2">
                            <span class="badge-with-logo dynamic-badge"
                                data-bg-color="{{index $.network_colors .Network}}">
                                <img src='/static/images/sources/badge/{{replace (lower .Network) " " "_"}}_logo.svg'
                                    alt="{{.Network}}" class="badge-logo"
                                    onerror="this.style.display='none'; var ph=this.nextElementSibling; ph.style.display='flex';">
                                <div class="badge-logo-placeholder" style="display: none;">
                                    {{slice .Network 0 1 | upper}}
                                </div>
                                {{.Network}}
                            </span>
                            <span style="font-weight: bold; font-size: 1.05rem;">{{.UserName}}</span>
                        </div>

                        <div class="source-meta flex items-center gap-2">
                            {{if .IsActive}}
                            {{if eq .SyncStatus "Synced"}}
                            <span class="badge badge-success">Synced</span>
                            {{else if eq .SyncStatus "Syncing"}}
                            <span class="badge badge-warning">Syncing</span>
                            {{else if eq .SyncStatus "Failed"}}
                            <span class="badge badge-danger">Failed</span>
                            {{else}}
                            <span class="badge badge-neutral">{{.SyncStatus}}</span>
                            {{end}}
                            {{else}}
                            <span class="badge badge-neutral">Disabled</span>
                            {{end}}

                            {{if .LastSynced.Valid}}
                            <span>last run: {{.LastSynced.Time.Format "Jan 02 15:04"}}</span>
                            {{end}}

                            {{if .StatusReason.Valid}}
                            <span title="{{.StatusReason.String}}"><i data-lucide="info"
                                    style="width: 14px; height: 14px;"></i></span>
                            {{end}}
                        </div>
                    </div>

                    <div class="source-actions">
                        <form method="POST" action="/sources/sync" onsubmit="return submitWithConfirm(this);">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Sync Now">
                                <i data-lucide="cloud-sync"></i>
                            </button>
                        </form>

                        {{if eq .Network "TikTok"}}
                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary btn-icon" title="Manage Cookies"
                                onclick="toggleDropdown('dd_{{.ID}}')">
                                <i data-lucide="key-round"></i>
                            </button>
                            <div id="dd_{{.ID}}" class="dropdown-content hidden">
                                <form method="GET" action="/sources/cookies/export">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item">
                                        <i data-lucide="download"></i> Export Cookies
                                    </button>
                                </form>
                                <form method="POST" action="/sources/cookies/import" enctype="multipart/form-data">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <input type="file" name="cookie_file" id="cookie_file_{{.ID}}" class="hidden"
                                        onchange="this.form.submit()">
                                    <button type="button" class="dropdown-item"
                                        onclick="document.getElementById('cookie_file_{{.ID}}').click()">
                                        <i data-lucide="upload"></i> Import Cookies
                                    </button>
                                </form>
                                <form method="GET" action="/auth/tiktok/login">
                                    <input type="hidden" name="username" value="{{.UserName}}">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i data-lucide="refresh-cw"></i> Renew Session
                                    </button>
                                </form>
                            </div>
                        </div>
                        {{end}}

                        {{if eq .Network "Instagram"}}
                        <form method="POST" action="/auth/facebook/refresh"
                            onsubmit="return submitWithConfirm(this, 'Refresh access token for this source?');">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Refresh Token">
                                <i data-lucide="key-round"></i>
                            </button>
                        </form>
                        {{end}}

                        {{if eq .Network "Discord"}}
                        <button type="button" class="btn btn-secondary btn-icon"
                            onclick="showDiscordChannels('{{.ID}}')" title="View / Update Channels">
                            <i data-lucide="hash"></i>
                        </button>
                        {{end}}

                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary btn-icon" title="Actions"
                                onclick="toggleDropdown('dd_actions_{{.ID}}')">
                                <i data-lucide="ellipsis"></i>
                            </button>
                            <div id="dd_actions_{{.ID}}" class="dropdown-content hidden" style="min-width: 140px;">
                                {{if .IsActive}}
                                <form method="POST" action="/sources/deactivate"
                                    onsubmit="return submitWithConfirm(this, 'Deactivate this source?');">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item" title="Disable">
                                        <i data-lucide="power"></i> Disable
                                    </button>
                                </form>
                                {{else}}
                                <form method="POST" action="/sources/activate"
                                    onsubmit="return submitWithConfirm(this);">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item" title="Enable">
                                        <i data-lucide="power"></i> Enable
                                    </button>
                                </form>
                                {{end}}

                                <form method="POST" action="/sources/delete"
                                    onsubmit="return submitWithConfirm(this, 'Delete this source?');">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item text-danger" title="Delete">
                                        <i data-lucide="trash-2"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const networkSelect = document.getElementById("network");
        const discordSection = document.getElementById("discord_section");
        const discordBotToken = document.getElementById("discord_bot_token");
        const discordServerId = document.getElementById("discord_server_id");
        const discordChannelIds = document.getElementById("discord_channel_ids");
        const instagramSection = document.getElementById("instagram_section");
        const profileInput = document.getElementById("instagram_profile_id");
        const InstAppId = document.getElementById("app_id");
        const InstAppSecret = document.getElementById("app_secret");

        const googleSection = document.getElementById("google_analytics_section");
        const googlePropertyId = document.getElementById("google_analytics_property_id");
        const googleKey = document.getElementById("google_service_account_key");

        const telegramSection = document.getElementById("telegram_section");
        const channelInput = document.getElementById("telegram_channel_id");
        const tgBotToken = document.getElementById("telegram_bot_token");
        const tgAppId = document.getElementById("telegram_app_id");
        const tgAppHash = document.getElementById("telegram_app_hash");
        const usernameInput = document.getElementById("username_input");

        if (!networkSelect) return;

        function updateVisibility() {
            const network = networkSelect.value;

            instagramSection.style.display = "none";
            profileInput.required = false;
            InstAppId.required = false;
            InstAppSecret.required = false;

            googleSection.style.display = "none";
            googlePropertyId.required = false;
            googleKey.required = false;

            telegramSection.style.display = "none";
            channelInput.required = false;
            tgBotToken.required = false;
            tgAppId.required = false;
            tgAppHash.required = false;

            discordSection.style.display = "none";
            discordBotToken.required = false;
            discordServerId.required = false;
            discordChannelIds.required = false;


            if (network === "Instagram") {
                instagramSection.style.display = "block";
                profileInput.required = true;
                InstAppId.required = true;
                InstAppSecret.required = true;
            } else if (network === "Google Analytics") {
                googleSection.style.display = "block";
                googlePropertyId.required = true;
                googleKey.required = true;
            } else if (network === "Telegram") {
                telegramSection.style.display = "block";
                channelInput.required = true;
                tgBotToken.required = true;
                tgAppId.required = true;
                tgAppHash.required = true;
            } else if (network === "Discord") {
                discordSection.style.display = "block";
                discordBotToken.required = true;
                discordServerId.required = true;
                discordChannelIds.required = true;
            } else if (network === "YouTube") {
                googleSection.style.display = "block";
                googlePropertyId.required = false;
                document.querySelector('label[for="google_analytics_property_id"]').style.display = 'none';
                googlePropertyId.style.display = 'none';
                googleKey.required = true;
            }

            if (network === "Mastodon") {
                usernameInput.placeholder = "username@instance.social";
            } else if (network === "Google Analytics") {
                usernameInput.placeholder = "Your website URL (e.g. https://example.com)";
            } else if (network === "Discord") {
                discordSection.style.display = "block";
                discordBotToken.required = true;
                discordServerId.required = true;
                discordChannelIds.required = true;
            } else if (network === "YouTube") {
                usernameInput.placeholder = "Your Channel Handle (e.g. @username)";
            } else if (network === "Discord") {
                usernameInput.placeholder = "Discord Username";
            } else {
                usernameInput.placeholder = "username (no @)";
            }
        }

        networkSelect.addEventListener("change", updateVisibility);
    });

    async function showDiscordChannels(sourceId) {
        try {
            const response = await fetch(`/sources/${sourceId}/channels`);
            const data = await response.json();

            if (response.ok) {
                const channelList = data.channels.join(', ');
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Discord Channels</h3>
                            <button onclick="this.closest('.modal-overlay').remove()" 
                                class="modal-close-btn" title="Close">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <p class="modal-text-muted">
                                Enter channel IDs separated by commas:
                            </p>
                            <textarea id="channel-ids-input" class="form-input modal-textarea"
                                placeholder="123456789, 987654321, 456789123">${channelList}</textarea>
                            <div class="modal-info-box">
                                <p>
                                    <strong>Note:</strong> Removed channels will have their posts permanently deleted on next sync.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button onclick="this.closest('.modal-overlay').remove()" 
                                class="btn btn-secondary">Cancel</button>
                            <button onclick="saveDiscordChannels('${sourceId}')" 
                                class="btn btn-primary">Save Changes</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };

                document.getElementById('channel-ids-input').focus();
            } else {
                alert(data.error || 'Failed to fetch channels');
            }
        } catch (error) {
            console.error('Error fetching Discord channels:', error);
            alert('Failed to fetch channels');
        }
    }

    async function saveDiscordChannels(sourceId) {
        const input = document.getElementById('channel-ids-input');
        const channelIds = input.value
            .split(',')
            .map(id => id.trim())
            .filter(id => id.length > 0);

        if (channelIds.length === 0) {
            alert('Please enter at least one channel ID');
            return;
        }

        try {
            const response = await fetch(`/sources/${sourceId}/channels`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ channels: channelIds })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Channels updated successfully! Changes will take effect on next sync.');
                document.querySelector('.modal-overlay').remove();
                location.reload();
            } else {
                alert(data.error || 'Failed to update channels');
            }
        } catch (error) {
            console.error('Error updating Discord channels:', error);
            alert('Failed to update channels');
        }
    }


    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.dynamic-badge').forEach(el => {
            el.style.backgroundColor = el.dataset.bgColor;
        });

        const syncingBadges = Array.from(document.querySelectorAll('.badge-warning')).filter(el => el.textContent.trim() === 'Syncing');
        if (syncingBadges.length > 0) {
            console.log("Sync in progress detected, scheduling reload...");
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        }
    });
</script>

{{ template "footer.html" . }}