{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <div>
        <h1>Sources</h1>
    </div>

    <div class="flex gap-2">
        <form method="GET" action="/sources">
            <button class="btn btn-secondary btn-icon" title="Refresh">
                <i data-lucide="refresh-cw"></i> Refresh
            </button>
        </form>

    </div>
</div>

<div class="grid-responsive">
    <div>
        <div class="card">
            <div class="card-header">Add New Source</div>
            <form method="POST" action="/sources/setup" id="source_form">
                <input type="hidden" name="user_id" value="{{.user_id}}">

                <div class="form-group">
                    <label class="form-label" for="network">Network</label>
                    <select id="network" name="network" class="form-select" required>
                        <option value="" disabled selected>Select Network</option>
                        <option value="Bluesky">Bluesky</option>
                        <option value="Instagram">Instagram</option>
                        <option value="TikTok">TikTok</option>
                        <option value="YouTube">YouTube</option>
                        <option value="Mastodon">Mastodon</option>
                        <option value="Telegram">Telegram</option>
                        <option value="Murrtube">Murrtube</option>
                        <option value="BadPups">BadPups</option>
                        <option value="FurTrack">FurTrack</option>
                        <option value="Google Analytics">Google Analytics</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="username_input">Username</label>
                    <input type="text" id="username_input" name="username" class="form-input"
                        placeholder="username (no @)" required>
                </div>

                <div class="form-group" id="instagram_section" style="display:none;">
                    <label class="form-label" for="instagram_profile_id">Instagram Profile ID</label>
                    <input id="instagram_profile_id" name="instagram_profile_id" class="form-input"
                        placeholder="123456789">

                    <label class="form-label" for="app_id">App ID</label>
                    <input id="app_id" name="app_id" class="form-input" placeholder="Facebook App ID">

                    <label class="form-label" for="app_secret">App Secret</label>
                    <input id="app_secret" name="app_secret" type="password" class="form-input"
                        placeholder="Facebook App Secret">
                </div>

                <div class="form-group" id="google_analytics_section" style="display:none;">
                    <label class="form-label" for="google_analytics_property_id">Property ID</label>
                    <input id="google_analytics_property_id" name="google_analytics_property_id" class="form-input"
                        placeholder="e.g. 34221144">
                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Found in Admin > Property
                        Settings</p>

                    <label class="form-label" for="google_service_account_key">Service Account JSON Key</label>
                    <textarea id="google_service_account_key" name="google_service_account_key" class="form-input"
                        rows="5" placeholder='{"type": "service_account", ...}'></textarea>
                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Create a Service Account in
                        Google Cloud
                        Console, download the JSON key, and paste it here.</p>
                </div>

                <div class="form-group" id="telegram_section" style="display:none;">

                    <label class="form-label" for="telegram_bot_token">Telegram Bot Token</label>
                    <input id="telegram_bot_token" name="telegram_bot_token" class="form-input"
                        placeholder="your_bot-token">

                    <label class="form-label" for="telegram_channel_id">Telegram Channel ID</label>
                    <input id="telegram_channel_id" name="telegram_channel_id" class="form-input"
                        placeholder="your_channel_id">

                    <label class="form-label" for="telegram_app_id">Telegram App ID</label>
                    <input id="telegram_app_id" name="telegram_app_id" class="form-input" placeholder="your_app_id">

                    <label class="form-label" for="telegram_app_hash">Telegram App Hash</label>
                    <input id="telegram_app_hash" name="telegram_app_hash" class="form-input"
                        placeholder="your_app_hash">

                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i data-lucide="plus"></i> Add Source
                </button>
            </form>
        </div>
    </div>

    <div>
        <div class="card">
            <div class="card-header">User Sources</div>

            {{if not .sources}}
            <div class="text-center" style="padding: 2rem; color: var(--color-text-muted);">
                <i data-lucide="ghost" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                <p>No sources connected yet.</p>
            </div>
            {{else}}
            <div class="flex flex-col gap-2">
                {{range .sources}}
                <div class="source-item">
                    <div class="source-info">
                        <div class="flex items-center gap-2">
                            <span style="font-weight: bold; font-size: 1.05rem;">{{.UserName}}</span>
                            <span class="badge badge-neutral">{{.Network}}</span>
                        </div>

                        <div class="source-meta flex items-center gap-2">
                            {{if .IsActive}}
                            {{if eq .SyncStatus "Synced"}}
                            <span class="badge badge-success">Synced</span>
                            {{else if eq .SyncStatus "Syncing"}}
                            <span class="badge badge-warning">Syncing</span>
                            {{else if eq .SyncStatus "Failed"}}
                            <span class="badge badge-danger">Failed</span>
                            {{else}}
                            <span class="badge badge-neutral">{{.SyncStatus}}</span>
                            {{end}}
                            {{else}}
                            <span class="badge badge-neutral">Disabled</span>
                            {{end}}

                            {{if .LastSynced.Valid}}
                            <span>updated {{.LastSynced.Time.Format "Jan 02 15:04"}}</span>
                            {{end}}

                            {{if .StatusReason.Valid}}
                            <span title="{{.StatusReason.String}}"><i data-lucide="info"
                                    style="width: 14px; height: 14px;"></i></span>
                            {{end}}
                        </div>
                    </div>

                    <div class="source-actions">
                        <form method="POST" action="/sources/sync" onsubmit="return submitWithConfirm(this);">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Sync Now">
                                <i data-lucide="cloud-sync"></i>
                            </button>
                        </form>

                        {{if .IsActive}}
                        <form method="POST" action="/sources/deactivate"
                            onsubmit="return submitWithConfirm(this, 'Deactivate this source?');">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" title="Disable">
                                <i data-lucide="power"></i>
                            </button>
                        </form>
                        {{else}}
                        <form method="POST" action="/sources/activate" onsubmit="return submitWithConfirm(this);">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-secondary btn-icon" title="Enable">
                                <i data-lucide="power"></i>
                            </button>
                        </form>
                        {{end}}

                        {{if eq .Network "TikTok"}}
                        <div class="dropdown">
                            <button type="button" class="btn btn-secondary btn-icon" title="Manage Cookies"
                                onclick="toggleDropdown('dd_{{.ID}}')">
                                <i data-lucide="key-round"></i>
                            </button>
                            <div id="dd_{{.ID}}" class="dropdown-content hidden">
                                <form method="GET" action="/sources/cookies/export">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <button type="submit" class="dropdown-item">
                                        <i data-lucide="download"></i> Export Cookies
                                    </button>
                                </form>
                                <form method="POST" action="/sources/cookies/import" enctype="multipart/form-data">
                                    <input type="hidden" name="source_id" value="{{.ID}}">
                                    <input type="file" name="cookie_file" id="cookie_file_{{.ID}}" class="hidden"
                                        onchange="this.form.submit()">
                                    <button type="button" class="dropdown-item"
                                        onclick="document.getElementById('cookie_file_{{.ID}}').click()">
                                        <i data-lucide="upload"></i> Import Cookies
                                    </button>
                                </form>
                                <form method="GET" action="/auth/tiktok/login">
                                    <input type="hidden" name="username" value="{{.UserName}}">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i data-lucide="refresh-cw"></i> Renew Session
                                    </button>
                                </form>
                            </div>
                        </div>
                        {{end}}

                        {{if eq .Network "Instagram"}}
                        <form method="POST" action="/auth/facebook/refresh"
                            onsubmit="return submitWithConfirm(this, 'Refresh access token for this source?');">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-danger btn-icon" {{if not .IsActive}}disabled{{end}}
                                title="Refresh Token">
                                <i data-lucide="key-round"></i>
                            </button>
                        </form>
                        {{end}}

                        <form method="POST" action="/sources/delete"
                            onsubmit="return submitWithConfirm(this, 'Delete this source?');">
                            <input type="hidden" name="source_id" value="{{.ID}}">
                            <button type="submit" class="btn btn-danger btn-icon" title="Delete">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const networkSelect = document.getElementById("network");
        const instagramSection = document.getElementById("instagram_section");
        const profileInput = document.getElementById("instagram_profile_id");
        const InstAppId = document.getElementById("app_id");
        const InstAppSecret = document.getElementById("app_secret");

        const googleSection = document.getElementById("google_analytics_section");
        const googlePropertyId = document.getElementById("google_analytics_property_id");
        const googleKey = document.getElementById("google_service_account_key");

        const telegramSection = document.getElementById("telegram_section");
        const channelInput = document.getElementById("telegram_channel_id");
        const tgBotToken = document.getElementById("telegram_bot_token");
        const tgAppId = document.getElementById("telegram_app_id");
        const tgAppHash = document.getElementById("telegram_app_hash");
        const usernameInput = document.getElementById("username_input");

        if (!networkSelect) return;

        function updateVisibility() {
            const network = networkSelect.value;

            instagramSection.style.display = "none";
            profileInput.required = false;
            InstAppId.required = false;
            InstAppSecret.required = false;

            googleSection.style.display = "none";
            googlePropertyId.required = false;
            googleKey.required = false;

            telegramSection.style.display = "none";
            channelInput.required = false;
            tgBotToken.required = false;
            tgAppId.required = false;
            tgAppHash.required = false;


            if (network === "Instagram") {
                instagramSection.style.display = "block";
                profileInput.required = true;
                InstAppId.required = true;
                InstAppSecret.required = true;
            } else if (network === "Google Analytics") {
                googleSection.style.display = "block";
                googlePropertyId.required = true;
                googleKey.required = true;
            } else if (network === "Telegram") {
                telegramSection.style.display = "block";
                channelInput.required = true;
                tgBotToken.required = true;
                tgAppId.required = true;
                tgAppHash.required = true;
            } else if (network === "YouTube") {
                googleSection.style.display = "block";
                googlePropertyId.required = false;
                document.querySelector('label[for="google_analytics_property_id"]').style.display = 'none';
                googlePropertyId.style.display = 'none';
                googleKey.required = true;
            }

            if (network === "Mastodon") {
                usernameInput.placeholder = "username@instance.social";
            } else if (network === "Google Analytics") {
                usernameInput.placeholder = "Your website URL (e.g. https://example.com)";
            } else if (network === "YouTube") {
                usernameInput.placeholder = "Your Channel Handle (e.g. @username)";
            } else {
                usernameInput.placeholder = "username (no @)";
            }
        }

        networkSelect.addEventListener("change", updateVisibility);
    });

    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d.id !== id) d.classList.add('hidden');
        });

        const dropdown = document.getElementById(id);
        if (dropdown) {
            dropdown.classList.toggle('hidden');
        }
    }

    window.onclick = function (event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(d => {
                d.classList.add('hidden');
            });
        }
    }
</script>

{{ template "footer.html" . }}