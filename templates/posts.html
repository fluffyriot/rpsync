{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
  <div>
    <h1>Posts</h1>
    <p class="text-muted">All your synchronized posts across networks</p>
  </div>

  <div class="flex gap-2">
    <form method="GET" action="/posts">
      <button class="btn btn-secondary btn-icon" title="Refresh">
        <i data-lucide="refresh-cw"></i> Refresh
      </button>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">All Posts ({{len .posts}} total)</div>

  {{if not .posts}}
  <div class="text-center posts-empty-state">
    <i data-lucide="file-text" class="posts-empty-icon"></i>
    <p>No posts found.</p>
  </div>
  {{else}}
  <div class="table-responsive">
    <table id="postsTable" class="display">
      <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th>Network</th>
          <th>Post Type</th>
          <th>Interactions</th>
          <th>Views</th>
          <th>Link</th>
          <th>Content</th>
        </tr>
      </thead>
      <!-- prettier-ignore -->
      <tbody>
        {{range .posts}}
        <tr data-network-id="{{.Post.NetworkInternalID}}"
          data-likes="{{if .Post.Likes.Valid}}{{.Post.Likes.Int32}}{{else}}-{{end}}"
          data-reposts="{{if .Post.Reposts.Valid}}{{.Post.Reposts.Int32}}{{else}}-{{end}}"
          data-status="{{if .Post.IsArchived}}Archived{{else}}Active{{end}}"
          data-full-content="{{if .Post.Content.Valid}}{{.Post.Content.String}}{{else}}-{{end}}"
          data-author="{{.Post.Author}}">
          <td class="details-control"></td>
          <td data-order="{{.Post.CreatedAt.Unix}}">{{.Post.CreatedAt.Format "Jan 02, 2006 15:04"}}</td>
          <td>
            {{if .Post.Network.Valid}}
            <span class="badge badge-neutral network-badge"
              data-network-color="{{index $.network_colors .Post.Network.String}}">
              {{.Post.Network.String}}
            </span>
            {{else}}-{{end}}
          </td>
          <td>{{if .Post.PostType}}{{.Post.PostType}}{{else}}-{{end}}</td>
          <td>{{.Post.Interactions}}</td>
          <td>{{if .Post.Views.Valid}}{{.Post.Views.Int32}}{{else}}-{{end}}</td>
          <td>
            {{if .URL}}
            <a href="{{.URL}}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-ghost btn-icon"
              title="View on {{.Post.Network.String}}">
              <i data-lucide="external-link" class="external-link-icon"></i>
            </a>
            {{else}}-{{end}}
          </td>
          <td>{{if .Post.Content.Valid}}{{truncate .Post.Content.String 50}}{{else}}-{{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

{{ template "footer.html" . }}

{{if .posts}}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.7/css/dataTables.dataTables.css" />
<script src="https://cdn.datatables.net/2.3.7/js/dataTables.js"></script>


<script>
  $(document).ready(function () {
    function formatChildRow(tr) {
      const networkId = tr.data('network-id');
      const author = tr.data('author');
      const likes = tr.data('likes');
      const reposts = tr.data('reposts');
      const status = tr.data('status');
      const fullContent = tr.data('full-content');

      return `
        <div class="child-row-details">
          <div><strong>Author:</strong> ${author || '-'}</div>
          <div><strong>Network ID:</strong> ${networkId}</div>
          <div><strong>Likes:</strong> ${likes}</div>
          <div><strong>Reposts:</strong> ${reposts}</div>
          <div><strong>Status:</strong> <span class="badge badge-${status === 'Archived' ? 'warning' : 'success'}">${status}</span></div>
          <div><strong>Full Content:</strong> ${fullContent}</div>
        </div>
      `;
    }

    const table = $('#postsTable').DataTable({
      pageLength: 25,
      order: [[1, 'desc']],
      responsive: false,
      searching: true,
      ordering: true,
      paging: true,
      lengthChange: true,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
      columnDefs: [
        {
          orderable: false,
          className: 'details-control',
          targets: 0
        },
        {
          orderable: false,
          targets: [3, 6, 7]  // Disable sorting on Post Type, Link, Content
        }
      ],
      language: {
        search: "Search posts:",
        lengthMenu: "Show _MENU_ posts per page",
        info: "Showing _START_ to _END_ of _TOTAL_ posts",
        infoEmpty: "No posts available",
        infoFiltered: "(filtered from _MAX_ total posts)",
        paginate: {
          first: "First",
          last: "Last",
          next: "Next",
          previous: "Previous"
        }
      }
    });

    const filterContainer = $('<div class="filter-container"></div>');

    const networks = [];
    table.column(2).data().unique().sort().each(function (d) {
      const network = $(d).text().trim();
      if (network && network !== '-') networks.push(network);
    });

    const networkSelect = $('<select class="form-control filter-select"><option value="">All Networks</option></select>');
    networks.forEach(network => {
      networkSelect.append(`<option value="${network}">${network}</option>`);
    });

    networkSelect.on('change', function () {
      const val = $(this).val();
      table.column(2).search(val ? '^' + val + '$' : '', true, false).draw();
    });

    const postTypes = [];
    table.column(3).data().unique().sort().each(function (d) {
      const type = $(d).text().trim();
      if (type && type !== '-') postTypes.push(type);
    });

    const postTypeSelect = $('<select class="form-control filter-select"><option value="">All Post Types</option></select>');
    postTypes.forEach(type => {
      postTypeSelect.append(`<option value="${type}">${type}</option>`);
    });

    postTypeSelect.on('change', function () {
      const val = $(this).val();
      table.column(3).search(val ? '^' + val + '$' : '', true, false).draw();
    });

    filterContainer.append('<label class="filter-label">Network: </label>').append(networkSelect);
    filterContainer.append('<label class="filter-label">Post Type: </label>').append(postTypeSelect);

    $('.dataTables_filter').before(filterContainer);

    $('#postsTable tbody').on('click', 'td.details-control', function () {
      const tr = $(this).closest('tr');
      const row = table.row(tr);

      if (row.child.isShown()) {
        row.child.hide();
        tr.removeClass('shown');
      } else {
        row.child(formatChildRow(tr)).show();
        tr.addClass('shown');
      }
    });

    $('.network-badge[data-network-color]').each(function () {
      $(this).css('background-color', $(this).attr('data-network-color'));
    });
  });
</script>
{{end}}