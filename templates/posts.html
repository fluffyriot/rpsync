{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
  <div>
    <h1>Posts</h1>
    <p class="text-muted">All your synchronized posts across networks</p>
  </div>

  <div class="flex gap-2 items-end">
    <div class="dropdown" id="dateFilterDropdown">
      <button class="btn btn-secondary btn-icon" id="dateFilterBtn" type="button">
        <i data-lucide="calendar"></i> Dates <i data-lucide="chevron-down" class="icon-chevron-down"></i>
      </button>
      <div class="filter-dropdown date-filter-dropdown p-3">
        <div class="mb-4">
          <label class="form-label-bold mb-2">Suggested</label>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="today">Today</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="yesterday">Yesterday</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="thisWeek">This Week</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="thisMonth">This Month</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="thisYear">This Year</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="last7">Last 7 Days</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="last30">Last 30 Days</button>
            <button class="btn btn-sm btn-ghost date-suggestion" data-range="last365">Last 365 Days</button>
          </div>
        </div>
        <div class="mb-2 border-t pt-2">
          <label class="form-label-bold mb-2">Custom</label>
        </div>
        <div class="form-group mb-sm">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-input dropdown-input" />
        </div>
        <div class="form-group mb-4">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-input dropdown-input" />
        </div>
        <div class="flex justify-between">
          <button class="btn btn-sm btn-ghost" id="clearDates">Clear</button>
          <button class="btn btn-sm btn-primary" id="applyDates">Apply</button>
        </div>
      </div>
    </div>
    <form method="GET" action="/posts">
      <button class="btn btn-secondary btn-icon" title="Refresh">
        <i data-lucide="refresh-cw"></i> Refresh
      </button>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">All Posts ({{len .posts}} total)</div>

  {{if not .posts}}
  <div class="text-center posts-empty-state">
    <i data-lucide="file-text" class="posts-empty-icon"></i>
    <p>No posts found.</p>
  </div>
  {{else}}
  <div class="table-responsive">
    <table id="postsTable" class="display">
      <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th class="th-filterable">Source</th>
          <th class="th-filterable">Post Type</th>
          <th>Likes & Reposts</th>
          <th>Views</th>
          <th>Link</th>
          <th>Content</th>
        </tr>
      </thead>
      <tfoot class="posts-table-footer">
        <tr>
          <th colspan="4" class="text-right">Total:</th>
          <th id="totalLikes"></th>
          <th id="totalViews"></th>
          <th></th>
          <th></th>
        </tr>
      </tfoot>
      <tbody>
        {{range .posts}}
        <tr data-network-id="{{.Post.NetworkInternalID}}"
          data-likes="{{if .Post.Likes.Valid}}{{.Post.Likes.Int64}}{{else}}-{{end}}"
          data-reposts="{{if .Post.Reposts.Valid}}{{.Post.Reposts.Int64}}{{else}}-{{end}}"
          data-status="{{if .Post.IsArchived}}Archived{{else}}Active{{end}}"
          data-full-content="{{if .Post.Content.Valid}}{{.Post.Content.String}}{{else}}-{{end}}"
          data-author="{{.Post.Author}}" data-url="{{.URL}}" data-source-id="{{.Post.SourceID}}">
          <td class="details-control"></td>
          <td data-order="{{.Post.CreatedAt.Unix}}">{{.Post.CreatedAt.Format "Jan 02, 2006 15:04"}}</td>
          <td data-search="{{if .Post.Network.Valid}}{{.Post.Network.String}}{{else}}-{{end}}">
            {{if .Post.Network.Valid}}
            <span class="badge badge-neutral network-badge">
              {{.Post.Network.String}}
            </span>
            {{else}}-{{end}}
          </td>
          <td data-search="{{if .Post.PostType}}{{.Post.PostType}}{{else}}-{{end}}">{{if
            .Post.PostType}}{{.Post.PostType}}{{else}}-{{end}}</td>
          <td>{{.Post.Interactions}}</td>
          <td>{{if .Post.Views.Valid}}{{.Post.Views.Int64}}{{else}}-{{end}}</td>
          <td>
            {{if .URL}}
            <a href="{{.URL}}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-ghost btn-icon"
              title="View on {{.Post.Network.String}}">
              <i data-lucide="external-link" class="external-link-icon"></i>
            </a>
            {{else}}-{{end}}
          </td>
          <td>{{if .Post.Content.Valid}}{{truncate .Post.Content.String 50}}{{else}}-{{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

{{ template "footer.html" . }}

{{if .posts}}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.7/css/dataTables.dataTables.css"
  integrity="sha384-Kpc+mQszh3/vUH/OusOZEQCoj2/fArR4w17g++67npFyTwNdldK7hGUdfHoHUX3b" crossorigin="anonymous" />
<script src="https://cdn.datatables.net/2.3.7/js/dataTables.js"
  integrity="sha384-2FgczAMyd99nlgHFfIt2rDxfzz+8hyAkY9ufMw3A0vLlvio4vKVimC/GMFkdkbAq" crossorigin="anonymous"></script>


<script>
  $(document).ready(function () {
    function formatChildRow(tr) {
      const networkId = tr.data('network-id');
      const author = tr.data('author');
      const likes = tr.data('likes');
      const reposts = tr.data('reposts');
      const status = tr.data('status');
      const fullContent = tr.data('full-content');
      const url = tr.data('url');
      const sourceId = tr.data('source-id');

      const $div = $('<div/>').addClass('child-row-details');
      const $info = $('<div/>').addClass('mb-4');

      const createRow = (label, value) => {
        const $row = $('<div/>').addClass('child-row-details-row');
        $row.append($('<strong/>').text(label + ': '));
        $row.append($('<span/>').addClass('child-row-value').text(' ' + (value || '-')));
        return $row;
      };

      $info.append(createRow('Author', author));
      $info.append(createRow('Internal ID', networkId));
      $info.append(createRow('Likes', likes));
      $info.append(createRow('Reposts', reposts));

      const $statusRow = $('<div/>');
      $statusRow.append($('<strong/>').text('Status: '));
      const badgeClass = status === 'Archived' ? 'badge-warning' : 'badge-success';
      const $badge = $('<span/>').addClass('badge status-badge ' + badgeClass).text(status);
      $statusRow.append(document.createTextNode(' '));
      $statusRow.append($badge);
      $info.append($statusRow);

      $info.append(createRow('Full Content', fullContent));
      $div.append($info);

      const $buttons = $('<div/>').addClass('flex gap-2');

      if (url) {
        const $link = $('<a/>', {
          href: url,
          target: '_blank',
          rel: 'noopener noreferrer',
          class: 'btn btn-secondary btn-sm',
          text: ' Go to Post'
        });
        $link.prepend($('<i/>', { 'data-lucide': 'external-link', class: 'icon-sm' }));
        $buttons.append($link);
      }

      const $excludeBtn = $('<button/>', {
        class: 'btn btn-danger btn-sm',
        text: ' Remove from Sync'
      });
      $excludeBtn.prepend($('<i/>', { 'data-lucide': 'file-x', class: 'icon-sm' }));
      $excludeBtn.on('click', function () {
        excludePost(sourceId, networkId);
      });
      $buttons.append($excludeBtn);

      $div.append($buttons);

      setTimeout(() => lucide.createIcons(), 0);

      return $div;
    }

    $.fn.dataTable.ext.search.push(
      function (settings, data, dataIndex) {
        const minStr = $('#startDate').val();
        const maxStr = $('#endDate').val();

        if (!minStr && !maxStr) return true;

        const createdAtUnix = parseFloat(settings.aoData[dataIndex]._aData[1]['@data-order']) || 0;

        let minTime = null;
        if (minStr) {
          const parts = minStr.split('-');
          minTime = new Date(parts[0], parts[1] - 1, parts[2]).getTime() / 1000;
        }

        let maxTime = null;
        if (maxStr) {
          const parts = maxStr.split('-');
          const d = new Date(parts[0], parts[1] - 1, parts[2]);
          d.setDate(d.getDate() + 1);
          maxTime = d.getTime() / 1000;
        }

        if (minTime && maxTime) {
          return createdAtUnix >= minTime && createdAtUnix < maxTime;
        }
        if (minTime) {
          return createdAtUnix >= minTime;
        }
        if (maxTime) {
          return createdAtUnix < maxTime;
        }
        return true;
      }
    );

    const table = $('#postsTable').DataTable({
      order: [[1, 'desc']],
      responsive: false,
      scrollY: '60vh',
      scrollCollapse: true,
      paging: true,
      layout: {
        topStart: 'pageLength',
        topEnd: 'search',
        top2Start: 'info',
        top2End: 'paging',
        bottomStart: null,
        bottomEnd: null
      },
      ordering: true,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
      columnDefs: [
        {
          orderable: false,
          className: 'details-control',
          targets: 0
        },
        {
          orderable: false,
          targets: [2, 3, 6, 7]
        }
      ],
      language: {
        search: "Search posts: ",
        lengthMenu: "Show _MENU_ posts per page",
        info: "_START_ to _END_ of _TOTAL_ posts",
        infoEmpty: "No posts found",
        infoFiltered: ""
      },
      footerCallback: function (row, data, start, end, display) {
        var api = this.api();

        var intVal = function (i) {
          return typeof i === 'string' ?
            i.replace(/[\$,]/g, '') * 1 :
            typeof i === 'number' ?
              i : 0;
        };

        totalLikes = api
          .column(4, { search: 'applied' })
          .data()
          .reduce(function (a, b) {
            if (b === '-') return intVal(a);
            return intVal(a) + intVal(b);
          }, 0);

        totalViews = api
          .column(5, { search: 'applied' })
          .data()
          .reduce(function (a, b) {
            if (b === '-') return intVal(a);
            return intVal(a) + intVal(b);
          }, 0);

        $(api.column(4).footer()).html(totalLikes);
        $(api.column(5).footer()).html(totalViews);
      }
    });

    let isFiltering = false;

    function updateDateButtonState() {
      const hasFilter = $('#startDate').val() || $('#endDate').val();
      const $btn = $('#dateFilterBtn');
      if (hasFilter) {
        $btn.removeClass('btn-secondary').addClass('btn-primary');
      } else {
        $btn.removeClass('btn-primary').addClass('btn-secondary');
      }
    }

    $('#applyDates').on('click', function () {
      updateDateButtonState();
      table.draw();
      $('#dateFilterDropdown .filter-dropdown').removeClass('show');
    });

    $('#clearDates').on('click', function () {
      $('#startDate').val('');
      $('#endDate').val('');
      updateDateButtonState();
      table.draw();
      $('#dateFilterDropdown .filter-dropdown').removeClass('show');
      $('.date-suggestion').removeClass('btn-primary').addClass('btn-ghost');
    });

    $('#dateFilterBtn').on('click', function (e) {
      e.stopPropagation();
      $('#dateFilterDropdown .filter-dropdown').toggleClass('show');
    });

    $('#dateFilterDropdown .filter-dropdown').on('click', function (e) {
      e.stopPropagation();
    });

    $(document).on('click', function (e) {
      if (!$(e.target).closest('#dateFilterDropdown').length) {
        $('#dateFilterDropdown .filter-dropdown').removeClass('show');
      }
    });

    $('.date-suggestion').on('click', function () {
      const range = $(this).data('range');
      const today = new Date();
      let start = new Date();
      let end = new Date();

      switch (range) {
        case 'today':
          break;
        case 'yesterday':
          start.setDate(today.getDate() - 1);
          end.setDate(today.getDate() - 1);
          break;
        case 'thisWeek':
          const day = today.getDay();
          const diff = today.getDate() - day + (day == 0 ? -6 : 1);
          start.setDate(diff);
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'thisYear':
          start = new Date(today.getFullYear(), 0, 1);
          break;
        case 'last7':
          start.setDate(today.getDate() - 6);
          break;
        case 'last30':
          start.setDate(today.getDate() - 29);
          break;
        case 'last365':
          start.setDate(today.getDate() - 364);
          break;
      }

      const formatDate = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
      }

      $('#startDate').val(formatDate(start));
      $('#endDate').val(formatDate(end));

      updateDateButtonState();
      table.draw();
      $('.date-suggestion').removeClass('btn-primary').addClass('btn-ghost');
      $(this).removeClass('btn-ghost').addClass('btn-primary');
    });

    $('#startDate, #endDate').on('input', function () {
      $('.date-suggestion').removeClass('btn-primary').addClass('btn-ghost');
    });

    $('#clearDates').on('click', function () {
      $('.date-suggestion').removeClass('btn-primary').addClass('btn-ghost');
    });

    table.columns([2, 3]).every(function () {
      const column = this;
      const header = $(column.header());
      const title = header.text();

      const headerContent = $('<div class="filter-header-content"></div>');
      const triggerIcon = $('<span class="filter-trigger"><i data-lucide="filter"></i></span>');
      const titleSpan = $('<span></span>').text(title);

      headerContent.append(triggerIcon).append(titleSpan);
      header.empty().append(headerContent);
      const dropdown = $('<div class="filter-dropdown"></div>');
      const actionRow = $('<div class="filter-actions"></div>');
      const selectAllBtn = $('<span class="filter-action-btn">Select All</span>');
      const clearBtn = $('<span class="filter-action-btn">Clear</span>');

      actionRow.append(selectAllBtn).append(clearBtn);
      dropdown.append(actionRow);

      const optionsContainer = $('<div></div>');
      dropdown.append(optionsContainer);

      const uniqueData = [];
      column.data().unique().sort().each(function (d) {
        if (!d) return;
        const parser = new DOMParser();
        const doc = parser.parseFromString(d, 'text/html');
        const val = doc.body.textContent.trim();
        if (val && val !== '-' && !uniqueData.includes(val)) {
          uniqueData.push(val);
        }
      });

      uniqueData.forEach(val => {
        const option = $('<label>').addClass('filter-option');
        const input = $('<input>').attr('type', 'checkbox').val(val).prop('checked', true);
        option.append(input).append(document.createTextNode(' ' + val));
        optionsContainer.append(option);
      });

      header.find('.filter-header-content').append(dropdown);
      lucide.createIcons();

      const trigger = header.find('.filter-trigger');

      trigger.on('click', function (e) {
        e.stopPropagation();
        $('.filter-dropdown').not(dropdown).removeClass('show');
        $('.filter-trigger').not(trigger).removeClass('active');

        if (dropdown.hasClass('show')) {
          dropdown.removeClass('show');
          trigger.removeClass('active');
        } else {
          const rect = this.getBoundingClientRect();
          dropdown.css({
            'position': 'fixed',
            'top': (rect.bottom + 5) + 'px',
            'left': rect.left + 'px',
            'width': 'auto',
            'min-width': '200px',
            'max-width': '300px',
            'z-index': 10001
          });
          dropdown.addClass('show');
          trigger.addClass('active');
        }
      });
      dropdown.on('click', function (e) {
        e.stopPropagation();
      });

      function applyFilter() {
        const checked = [];
        optionsContainer.find('input:checked').each(function () {
          checked.push($(this).val());
        });

        const searchStr = checked.map(v => {
          return '^' + v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$';
        }).join('|');

        isFiltering = true;
        column.search(searchStr, true, false).draw();
        setTimeout(() => {
          isFiltering = false;
        }, 300);

        if (optionsContainer.find('input:not(:checked)').length > 0) {
          trigger.addClass('has-filter');
        } else {
          trigger.removeClass('has-filter');
        }
      }

      optionsContainer.on('change', 'input', applyFilter);

      selectAllBtn.on('click', function () {
        optionsContainer.find('input').prop('checked', true);
        applyFilter();
      });

      clearBtn.on('click', function () {
        optionsContainer.find('input').prop('checked', false);
        applyFilter();
      });

      $(document).on('click', function (e) {
        if (!$(e.target).closest('.filter-header-content, .filter-dropdown').length) {
          dropdown.removeClass('show');
          trigger.removeClass('active');
        }
      });
    });

    $('#postsTable tbody').on('click', 'td.details-control', function () {
      const tr = $(this).closest('tr');
      const row = table.row(tr);

      if (row.child.isShown()) {
        row.child.hide();
        tr.removeClass('shown');
      } else {
        row.child(formatChildRow(tr)).show();
        tr.addClass('shown');
      }
    });

    // Close filter dropdowns on table body scroll (DataTables 2)
    $('.dt-scroll-body, .dataTables_scrollBody').on('scroll', function () {
      if (isFiltering) return;
      $('.filter-dropdown.show').removeClass('show');
      $('.filter-trigger.active').removeClass('active');
    });

  });

  async function excludePost(sourceId, networkInternalId) {
    if (!confirm('Are you sure you want to exclude this post? It will be deleted and not synced again.')) {
      return;
    }

    const data = {
      source_id: sourceId,
      network_internal_id: networkInternalId
    };

    try {
      const response = await fetch('/api/exclusions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to add exclusion');
      }

      alert('Exclude added successfully! The post has been deleted.');
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>
{{end}}