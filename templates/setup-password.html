{{ template "header.html" . }}
<div class="container auth-container">
    <div class="card auth-card">
        <h3 class="card-header">Setup Password</h3>
        <div class="card-body">
            <p>To secure your account, please set a password.</p>
            <form method="POST" action="/setup/password">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input class="form-input" type="text" value="{{ .username }}" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input class="form-input" type="password" name="password" id="password" required
                        autocomplete="new-password">
                    <ul id="password-requirements" class="text-muted"
                        style="font-size: 0.8rem; padding-left: 1.2rem; margin-top: 0.5rem;">
                        <li id="req-len" class="text-danger">Min 8 characters</li>
                        <li id="req-upper" class="text-danger">Uppercase letter</li>
                        <li id="req-lower" class="text-danger">Lowercase letter</li>
                        <li id="req-num" class="text-danger">Number</li>
                        <li id="req-spec" class="text-danger">Special character</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input class="form-input" type="password" name="confirm_password" id="confirm_password" required
                        autocomplete="new-password">
                    <p id="match-error" class="text-danger hidden" style="font-size: 0.8rem; margin-top: 0.25rem;">
                        Passwords do not match</p>
                </div>
                <button class="btn btn-primary input-block" style="width: 100%;" type="submit" id="submit-btn"
                    disabled>Set Password</button>
                {{ if .error }}
                <div class="alert alert-danger u-margin-top-small">{{ .error }}</div>
                {{ end }}
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirm_password');
        const submitBtn = document.getElementById('submit-btn');
        const matchError = document.getElementById('match-error');

        const reqs = {
            len: el => el.value.length >= 8,
            upper: el => /[A-Z]/.test(el.value),
            lower: el => /[a-z]/.test(el.value),
            num: el => /[0-9]/.test(el.value),
            spec: el => /[!@#$%^&*(),.?":{}|<>\-=_+[\]\/\\';`~]/.test(el.value)
        };

        function validate() {
            let allValid = true;

            for (const [key, check] of Object.entries(reqs)) {
                const isValid = check(passwordInput);
                const li = document.getElementById(`req-${key}`);
                if (isValid) {
                    li.classList.remove('text-danger');
                    li.classList.add('text-success');
                } else {
                    li.classList.remove('text-success');
                    li.classList.add('text-danger');
                    allValid = false;
                }
            }

            const match = passwordInput.value === confirmInput.value && passwordInput.value !== "";
            if (confirmInput.value.length > 0) {
                if (match) {
                    matchError.classList.add('hidden');
                } else {
                    matchError.classList.remove('hidden');
                    allValid = false;
                }
            } else {
                matchError.classList.add('hidden');
                if (allValid) allValid = false;
            }
            if (!match) allValid = false;

            submitBtn.disabled = !allValid;
        }

        passwordInput.addEventListener('input', validate);
        confirmInput.addEventListener('input', validate);
    });
</script>
{{ template "footer.html" . }}