{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
  <div>
    <h1>Dashboard</h1>
    <p class="text-muted">Welcome back, <b>{{.username}}</b>!</p>
  </div>

  <div class="flex gap-2">
    <form method="GET" action="/">
      <button class="btn btn-secondary btn-icon" title="Refresh">
        <i data-lucide="refresh-cw"></i> Refresh
      </button>
    </form>

  </div>
</div>

{{if .top_sources}}
<div class="top-sources-grid">
  {{range .top_sources}}
  <div class="source-tile">
    <div class="source-tile-header">
      <img src="/static/images/sources/{{.Network | lower}}_logo.svg" alt="{{.Network}}" class="source-logo"
        onerror="this.style.display='none'; var ph=this.nextElementSibling; ph.style.display='flex'; ph.style.backgroundColor=ph.dataset.color;">
      <div class="source-logo-placeholder" style="display: none;" data-color="{{index $.network_colors .Network}}">
        {{slice .Network 0 1 | upper}}
      </div>
      <div style="min-width: 0;">
        <a href="{{.ProfileURL}}" target="_blank" class="source-name" title="{{.UserName}}">{{.UserName | stripAt}}</a>
        <div class="source-network">{{.Network}}</div>
      </div>
    </div>
    <div class="source-stats">
      <div class="source-stat">
        <span class="source-stat-value formatted-metric">{{.TotalInteractions}}</span>
        <span class="source-stat-label">Interactions</span>
      </div>
      <div class="source-stat source-stat-right">
        <span class="source-stat-value formatted-metric">{{.FollowersCount}}</span>
        <span class="source-stat-label">Followers</span>
      </div>
    </div>
  </div>
  {{end}}
</div>
{{end}}

<div class="dashboard-comparison-grid">
  <div class="card">
    <div class="card-header">Your Engagement</div>
    <div style="position: relative; height: 250px; width: 100%;">
      <canvas id="engagementComparisonChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header">Your Followers</div>
    <div style="position: relative; height: 250px; width: 100%;">
      <canvas id="followersComparisonChart"></canvas>
    </div>
  </div>
</div>

<div class="grid-dashboard">

  <div class="stat-card {{if .worker_is_off}}has-errors{{end}}">
    <div class="stat-icon"><i data-lucide="activity" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.worker_status}}</div>
    <div class="stat-label">Syncer Status</div>
    <a href="/settings/sync#syncer-config" class="stat-link">Manage Settings &rarr;</a>
  </div>


  {{if not .worker_is_off}}
  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="clock" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.sync_period}}</div>
    <div class="stat-label">Sync Frequency</div>
    <a href="/settings/sync#syncer-config" class="stat-link">Change Frequency &rarr;</a>
  </div>
  {{end}}


  <div class="stat-card {{if gt .sync_errors_30d 0}}has-errors{{end}}">
    <div class="stat-icon"><i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.sync_errors_30d}}</div>
    <div class="stat-label">Sync Errors (Last 30 days)</div>
    <a href="#recent-logs" class="stat-link">View Errors &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="server" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_sources}}</div>
    <div class="stat-label">Active Sources</div>
    <a href="/sources" class="stat-link">Manage Sources &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="database" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_targets}}</div>
    <div class="stat-label">Active Targets</div>
    <a href="/targets" class="stat-link">Manage Targets &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="file-text" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_posts}}</div>
    <div class="stat-label">Total Posts Tracked</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="heart" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_likes}}</div>
    <div class="stat-label">Total Likes</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="share-2" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_shares}}</div>
    <div class="stat-label">Total Shares/Reposts</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="eye" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_views}}</div>
    <div class="stat-label">Total Post Views</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="users" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_visitors}}</div>
    <div class="stat-label">Website Visitors</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="mouse-pointer" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_page_views}}</div>
    <div class="stat-label">Website Page Views</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="hourglass" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.average_website_session}}s</div>
    <div class="stat-label">Average Website Session</div>
  </div>

</div>

<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">Engagement Over Time</div>
  <div style="position: relative; height: 400px; width: 100%;">
    <canvas id="engagementChart"></canvas>
  </div>
</div>


<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">Website Analytics Over Time</div>
  <div style="position: relative; height: 400px; width: 100%;">
    <canvas id="analyticsChart"></canvas>
  </div>
</div>

<div class="card" id="recent-logs">
  <div class="card-header">Recent Sync Errors</div>
  {{if not .recent_logs}}
  <div class="text-center" style="padding: 2rem; color: var(--color-text-muted);">
    <i data-lucide="check-circle" style="width: 48px; height: 48px; opacity: 0.5; color: var(--color-success);"></i>
    <p>No recent errors found.</p>
  </div>
  {{else}}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
      <thead>
        <tr style="text-align: left; border-bottom: 1px solid var(--color-border);">
          <th style="padding: 0.75rem;">Time</th>
          <th style="padding: 0.75rem;">Source/Target</th>
          <th style="padding: 0.75rem;">Message</th>
        </tr>
      </thead>
      <tbody>
        {{range .recent_logs}}
        <tr style="border-bottom: 1px solid var(--color-border);">
          <td style="padding: 0.75rem; white-space: nowrap; color: var(--color-text-muted);">
            {{.CreatedAt.Format "Jan 02 15:04"}}
          </td>
          <td style="padding: 0.75rem;">
            {{if .SourceNetwork.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">{{.SourceNetwork.String}}</span>
              <span>{{.SourceUsername.String}}</span>
            </div>
            {{else if .TargetType.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">Target</span>
              <span>{{.TargetType.String}}</span>
            </div>
            {{else}}
            <span class="text-muted">System</span>
            {{end}}
          </td>
          <td style="padding: 0.75rem; color: var(--color-danger);">
            <div class="flex justify-between items-start gap-2">
              <span>{{.Message}}</span>
              <form method="POST" action="/logs/dismiss" style="margin: 0;">
                <input type="hidden" name="id" value="{{.ID}}">
                <button type="submit" class="btn btn-sm btn-ghost btn-icon" title="Dismiss"
                  style="padding: 2px; height: auto;">
                  <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

{{ template "footer.html" . }}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const metrics = document.querySelectorAll('.formatted-metric');
    metrics.forEach(el => {
      let val = parseInt(el.textContent.trim());
      if (isNaN(val)) return;

      if (val >= 100000) {
        let shortened = (val / 1000).toFixed(1);
        if (shortened.endsWith('.0')) {
          shortened = shortened.slice(0, -2);
        }
        el.textContent = shortened + 'k';
      } else if (val >= 1000) {
        el.textContent = val.toLocaleString();
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch('/analytics/website')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          return;
        }

        const ctx = document.getElementById('analyticsChart').getContext('2d');

        const datasets = [];
        const allDates = new Set();

        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333';

        const colorMap = {
          "Website Visitors": "#f9ab00",
          "Page Views": "#e37400"
        };

        data.forEach((series, index) => {
          const points = series.points || [];
          const dataPoints = points.map(p => {
            const dateStr = p.date;
            allDates.add(dateStr);
            return {
              x: dateStr,
              y: p.value
            };
          });

          let color = colorMap[series.label];
          if (!color) {
            const colors = ['#f87171', '#fbbf24', '#a78bfa', '#e879f9'];
            color = colors[index % colors.length];
          }

          datasets.push({
            label: '  ' + series.label,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color + '20',
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3
          });
        });

        const sortedDates = Array.from(allDates).sort();

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'category',
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Count' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                padding: 10,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label.trim() || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching analytics stats:", err));
  });
</script>

<script id="network-colors-data" type="application/json">
  {{.network_colors | json}}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch('/analytics/engagement')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          return;
        }

        const ctx = document.getElementById('engagementChart').getContext('2d');

        const datasets = [];
        const allDates = new Set();

        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333';

        let networkColors = {};
        try {
          networkColors = JSON.parse(document.getElementById('network-colors-data').textContent);
        } catch (e) {
          console.error("Failed to parse network colors", e);
        }

        data.forEach((source, index) => {
          const points = source.points || [];
          const dataPoints = points.map(p => {
            const dateStr = p.date;
            allDates.add(dateStr);
            return {
              x: dateStr,
              y: p.likes + p.reposts
            };
          });

          const color = networkColors[source.network] || '#9167e4';

          datasets.push({
            label: `  ${source.network} (${source.username})`,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3
          });
        });

        const sortedDates = Array.from(allDates).sort();

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'category',
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Total Engagement' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                padding: 10,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label.trim() || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching stats:", err));
  });
</script>

<script id="dashboard-summary-data" type="application/json">
  {{.dashboard_summary | json}}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let data;
    try {
      const el = document.getElementById('dashboard-summary-data');
      if (el && el.textContent.trim()) {
        data = JSON.parse(el.textContent);
      }
    } catch (e) {
      console.error("Failed to parse dashboard summary", e);
      return;
    }

    if (!data) return;

    function renderComparisonChart(ctxId, label, currentData, previousData, primaryColor) {
      const ctx = document.getElementById(ctxId).getContext('2d');

      const currentValues = currentData.map(p => p.value);
      const previousValues = previousData.map(p => p.value);

      const dayLabels = Array.from({ length: 7 }, (_, i) => `Day ${i + 1}`);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dayLabels,
          datasets: [
            {
              label: '  Last 7 Days',
              data: currentValues,
              borderColor: primaryColor,
              backgroundColor: primaryColor + '20',
              fill: true,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 2
            },
            {
              label: '  Previous 7 Days',
              data: previousValues,
              borderColor: '#6B7280',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              fill: false,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { display: true, maxTicksLimit: 7 }
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                boxWidth: 8
              }
            },
            tooltip: {
              backgroundColor: 'rgba(20, 20, 30, 0.9)',
              titleColor: '#fff',
              bodyColor: '#ccc',
              padding: 10,
              cornerRadius: 8,
              callbacks: {
                label: function (context) {
                  let idx = context.dataIndex;
                  let val = context.parsed.y;
                  let dateStr = '';
                  if (context.datasetIndex === 0 && currentData[idx]) {
                    dateStr = ` (${currentData[idx].date})`;
                  } else if (context.datasetIndex === 1 && previousData[idx]) {
                    dateStr = ` (${previousData[idx].date})`;
                  }
                  return `${context.dataset.label.trim()}: ${val}${dateStr}`;
                }
              }
            }
          }
        }
      });
    }

    if (data.engagement) {
      renderComparisonChart(
        'engagementComparisonChart',
        'Engagement',
        data.engagement.current_period,
        data.engagement.previous_period,
        '#9167e4'
      );
    }

    if (data.followers) {
      renderComparisonChart(
        'followersComparisonChart',
        'Followers',
        data.followers.current_period,
        data.followers.previous_period,
        '#9167e4'
      );
    }
  });
</script>