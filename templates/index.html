{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
  <div>
    <h1>Dashboard</h1>
    <p class="text-muted">Welcome back, <b>{{.username}}</b>!</p>
  </div>

  <div class="flex gap-2">
    <form method="GET" action="/">
      <button class="btn btn-secondary btn-icon" title="Refresh">
        <i data-lucide="refresh-cw"></i> Refresh
      </button>
    </form>

  </div>
</div>

{{if .top_sources}}
<div class="top-sources-grid">
  {{range .top_sources}}
  <div class="source-tile">
    <div class="source-tile-header">
      <img src="/static/images/sources/{{.Network | lower}}_logo.svg" alt="{{.Network}}" class="source-logo"
        onerror="this.style.display='none'; var ph=this.nextElementSibling; ph.style.display='flex'; ph.style.backgroundColor=ph.dataset.color;">
      <div class="source-logo-placeholder" style="display: none;" data-color="{{index $.network_colors .Network}}">
        {{slice .Network 0 1 | upper}}
      </div>
      <div style="min-width: 0;">
        <a href="{{.ProfileURL}}" target="_blank" class="source-name" title="{{.UserName}}">{{.UserName | stripAt}}</a>
        <div class="source-network">{{.Network}}</div>
      </div>
    </div>
    <div class="source-stats">
      <div class="source-stat">
        <span class="source-stat-value formatted-metric">{{.TotalInteractions}}</span>
        <span class="source-stat-label">Interactions</span>
      </div>
      <div class="source-stat source-stat-right">
        <span class="source-stat-value formatted-metric">{{.FollowersCount}}</span>
        <span class="source-stat-label">Followers</span>
      </div>
    </div>
  </div>
  {{end}}
  {{if and .top_sources (eq (len .top_sources) 3)}}
  <button id="show-all-sources-btn" class="btn btn-secondary w-full" style="grid-column: 1 / -1;"
    onclick="loadRestSources(this)">
    <i data-lucide="chevrons-down"></i> Show All
  </button>
  {{end}}
</div>
{{end}}

<div class="dashboard-comparison-grid">
  <div class="card">
    <div class="card-header">Your Engagement</div>
    <div style="position: relative; height: 250px; width: 100%;">
      <canvas id="engagementComparisonChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header">Your Followers</div>
    <div style="position: relative; height: 250px; width: 100%;">
      <canvas id="followersComparisonChart"></canvas>
    </div>
  </div>
</div>

<div class="grid-dashboard">

  <div class="stat-card {{if .worker_is_off}}has-errors{{end}}">
    <div class="stat-icon"><i data-lucide="activity" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.worker_status}}</div>
    <div class="stat-label">Syncer Status</div>
    <a href="/settings/sync#syncer-config" class="stat-link">Manage Settings &rarr;</a>
  </div>


  {{if not .worker_is_off}}
  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="clock" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.sync_period}}</div>
    <div class="stat-label">Sync Frequency</div>
    <a href="/settings/sync#syncer-config" class="stat-link">Change Frequency &rarr;</a>
  </div>
  {{end}}


  <div class="stat-card {{if gt .sync_errors_30d 0}}has-errors{{end}}">
    <div class="stat-icon"><i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.sync_errors_30d}}</div>
    <div class="stat-label">Sync Errors (Last 30 days)</div>
    <a href="#recent-logs" class="stat-link">View Errors &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="server" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_sources}}</div>
    <div class="stat-label">Active Sources</div>
    <a href="/sources" class="stat-link">Manage Sources &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="database" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_targets}}</div>
    <div class="stat-label">Active Targets</div>
    <a href="/targets" class="stat-link">Manage Targets &rarr;</a>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="file-text" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_posts}}</div>
    <div class="stat-label">Total Posts Tracked</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="heart" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_likes}}</div>
    <div class="stat-label">Total Likes</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="share-2" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_shares}}</div>
    <div class="stat-label">Total Shares/Reposts</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="eye" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_views}}</div>
    <div class="stat-label">Total Post Views</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="users" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_visitors}}</div>
    <div class="stat-label">Website Visitors</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="mouse-pointer" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_page_views}}</div>
    <div class="stat-label">Website Page Views</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="hourglass" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.average_website_session}}s</div>
    <div class="stat-label">Average Website Session</div>
  </div>

</div>

<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">Engagement Over Time</div>
  <div style="position: relative; height: 400px; width: 100%;">
    <canvas id="engagementChart"></canvas>
  </div>
</div>


<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">Website Analytics Over Time</div>
  <div style="position: relative; height: 400px; width: 100%;">
    <canvas id="analyticsChart"></canvas>
  </div>
</div>

<div class="card" id="recent-logs">
  <div class="card-header">Recent Sync Errors</div>
  {{if not .recent_logs}}
  <div class="text-center" style="padding: 2rem; color: var(--color-text-muted);">
    <i data-lucide="check-circle" style="width: 48px; height: 48px; opacity: 0.5; color: var(--color-success);"></i>
    <p>No recent errors found.</p>
  </div>
  {{else}}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
      <thead>
        <tr style="text-align: left; border-bottom: 1px solid var(--color-border);">
          <th style="padding: 0.75rem;">Time</th>
          <th style="padding: 0.75rem;">Source/Target</th>
          <th style="padding: 0.75rem;">Message</th>
        </tr>
      </thead>
      <tbody>
        {{range .recent_logs}}
        <tr style="border-bottom: 1px solid var(--color-border);">
          <td style="padding: 0.75rem; white-space: nowrap; color: var(--color-text-muted);">
            {{.CreatedAt.Format "Jan 02 15:04"}}
          </td>
          <td style="padding: 0.75rem;">
            {{if .SourceNetwork.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">{{.SourceNetwork.String}}</span>
              <span>{{.SourceUsername.String}}</span>
            </div>
            {{else if .TargetType.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">Target</span>
              <span>{{.TargetType.String}}</span>
            </div>
            {{else}}
            <span class="text-muted">System</span>
            {{end}}
          </td>
          <td style="padding: 0.75rem; color: var(--color-danger);">
            <div class="flex justify-between items-start gap-2">
              <span>{{.Message}}</span>
              <form method="POST" action="/logs/dismiss" style="margin: 0;">
                <input type="hidden" name="id" value="{{.ID}}">
                <button type="submit" class="btn btn-sm btn-ghost btn-icon" title="Dismiss"
                  style="padding: 2px; height: auto;">
                  <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

{{ template "footer.html" . }}



<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch('/analytics/website')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          return;
        }

        const ctx = document.getElementById('analyticsChart').getContext('2d');

        const datasets = [];
        const allDates = new Set();

        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333';

        const colorMap = {
          "Website Visitors": "#f9ab00",
          "Page Views": "#e37400"
        };

        data.forEach((series, index) => {
          const points = series.points || [];
          const dataPoints = points.map(p => {
            const dateStr = p.date;
            allDates.add(dateStr);
            return {
              x: dateStr,
              y: p.value
            };
          });

          let color = colorMap[series.label];
          if (!color) {
            const colors = ['#f87171', '#fbbf24', '#a78bfa', '#e879f9'];
            color = colors[index % colors.length];
          }

          datasets.push({
            label: '  ' + series.label,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color + '20',
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3
          });
        });

        const sortedDates = Array.from(allDates).sort();

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'category',
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Count' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                display: window.innerWidth >= 768,
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                padding: 10,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label.trim() || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching analytics stats:", err));
  });
</script>

<script id="network-colors-data" type="application/json">
  {{.network_colors | json}}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch('/analytics/engagement')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          return;
        }

        const ctx = document.getElementById('engagementChart').getContext('2d');

        const allDates = new Set();
        const networkGroups = {};

        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333';

        let networkColors = {};
        try {
          networkColors = JSON.parse(document.getElementById('network-colors-data').textContent);
        } catch (e) {
          console.error("Failed to parse network colors", e);
        }

        data.forEach(source => {
          if (!networkGroups[source.network]) {
            networkGroups[source.network] = new Map();
          }
          const points = source.points || [];
          points.forEach(p => {
            allDates.add(p.date);
            const current = networkGroups[source.network].get(p.date) || 0;
            networkGroups[source.network].set(p.date, current + p.likes + p.reposts);
          });
        });

        const sortedDates = Array.from(allDates).sort();

        const datasets = [];

        Object.keys(networkGroups).forEach(network => {
          const dateMap = networkGroups[network];
          const dataPoints = [];

          sortedDates.forEach(date => {
            let val = 0;
            if (dateMap.has(date)) {
              val = dateMap.get(date);
            }
            dataPoints.push(val);
          });

          const color = networkColors[network] || '#9167e4';

          datasets.push({
            label: ' ' + network,
            data: dataPoints,
            backgroundColor: color,
            borderColor: color,
            borderWidth: 1,
            fill: true,
          });
        });

        const totalLabelsPlugin = {
          id: 'totalLabels',
          afterDatasetsDraw: (chart, args, options) => {
            const { ctx, scales: { x, y } } = chart;
            ctx.save();
            ctx.font = 'bold 11px sans-serif';
            ctx.fillStyle = '#a0a0a0';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';

            chart.data.labels.forEach((label, index) => {
              let total = 0;
              let hasData = false;

              chart.data.datasets.forEach((dataset, i) => {
                if (chart.isDatasetVisible(i)) {
                  const val = dataset.data[index];
                  if (typeof val === 'number') {
                    total += val;
                    if (val > 0) hasData = true;
                  }
                }
              });

              if (hasData && total > 0) {
                const meta = chart.getDatasetMeta(0);
                if (meta.data[index]) {
                  const xPos = meta.data[index].x;
                  const yPos = y.getPixelForValue(total);
                  ctx.fillText(total, xPos, yPos - 5);
                }
              }
            });
            ctx.restore();
          }
        };

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedDates,
            datasets: datasets
          },
          plugins: [totalLabelsPlugin],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                stacked: true,
                type: 'category',
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                grace: '5%',
                title: { display: true, text: 'Posts Engagement' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                display: window.innerWidth >= 768,
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                padding: 10,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += context.parsed.y;
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching stats:", err));
  });
</script>

<script id="dashboard-summary-data" type="application/json">
  {{.dashboard_summary | json}}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let data;
    try {
      const el = document.getElementById('dashboard-summary-data');
      if (el && el.textContent.trim()) {
        data = JSON.parse(el.textContent);
      }
    } catch (e) {
      console.error("Failed to parse dashboard summary", e);
      return;
    }

    if (!data) return;

    function renderComparisonChart(ctxId, label, currentData, previousData, primaryColor) {
      const ctx = document.getElementById(ctxId).getContext('2d');

      const currentValues = currentData.map(p => p.value);
      const previousValues = previousData.map(p => p.value);

      const dayLabels = Array.from({ length: 7 }, (_, i) => `Day ${i + 1}`);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dayLabels,
          datasets: [
            {
              label: '  Last 7 Days',
              data: currentValues,
              borderColor: primaryColor,
              backgroundColor: primaryColor + '20',
              fill: true,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 2
            },
            {
              label: '  Previous 7 Days',
              data: previousValues,
              borderColor: '#6B7280',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              fill: false,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: { display: true, maxTicksLimit: 7 }
            },
            y: {
              beginAtZero: false,
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          },
          plugins: {
            legend: {
              display: window.innerWidth >= 768,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                boxWidth: 8
              }
            },
            tooltip: {
              backgroundColor: 'rgba(20, 20, 30, 0.9)',
              titleColor: '#fff',
              bodyColor: '#ccc',
              padding: 10,
              cornerRadius: 8,
              callbacks: {
                label: function (context) {
                  let idx = context.dataIndex;
                  let val = context.parsed.y;
                  let dateStr = '';
                  if (context.datasetIndex === 0 && currentData[idx]) {
                    dateStr = ` (${currentData[idx].date})`;
                  } else if (context.datasetIndex === 1 && previousData[idx]) {
                    dateStr = ` (${previousData[idx].date})`;
                  }
                  return `${context.dataset.label.trim()}: ${val}${dateStr}`;
                }
              }
            }
          }
        }
      });
    }

    if (data.engagement) {
      renderComparisonChart(
        'engagementComparisonChart',
        'Engagement',
        data.engagement.current_period,
        data.engagement.previous_period,
        '#9167e4'
      );
    }

    if (data.followers) {
      renderComparisonChart(
        'followersComparisonChart',
        'Followers',
        data.followers.current_period,
        data.followers.previous_period,
        '#9167e4'
      );
    }
  });
</script>

<script>
  function loadRestSources(btn) {
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Loading...';
    lucide.createIcons();

    fetch('/analytics/top-sources')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          btn.remove();
          return;
        }

        const grid = document.querySelector('.top-sources-grid');
        let networkColors = {};
        try {
          networkColors = JSON.parse(document.getElementById('network-colors-data').textContent);
        } catch (e) {
          console.error("Failed to parse network colors", e);
        }

        btn.remove();

        data.forEach(source => {
          const tile = document.createElement('div');
          tile.className = 'source-tile';

          const networkLower = source.Network.toLowerCase();
          const networkColor = networkColors[source.Network] || '#888';
          const networkInitial = source.Network.substring(0, 1).toUpperCase();
          const userNameStripped = source.UserName.replace(/^@/, '');

          const header = document.createElement('div');
          header.className = 'source-tile-header';

          const img = document.createElement('img');
          img.src = `/static/images/sources/${networkLower}_logo.svg`;
          img.alt = source.Network;
          img.className = 'source-logo';
          img.onerror = function () {
            this.style.display = 'none';
            const ph = this.nextElementSibling;
            if (ph) {
              ph.style.display = 'flex';
              ph.style.backgroundColor = ph.dataset.color;
            }
          };
          header.appendChild(img);

          const placeholder = document.createElement('div');
          placeholder.className = 'source-logo-placeholder';
          placeholder.style.display = 'none';
          placeholder.dataset.color = networkColor;
          placeholder.textContent = networkInitial;
          header.appendChild(placeholder);

          const infoDiv = document.createElement('div');
          infoDiv.style.minWidth = '0';

          const link = document.createElement('a');
          link.href = source.ProfileURL;
          link.target = '_blank';
          link.className = 'source-name';
          link.title = source.UserName;
          link.textContent = userNameStripped;
          infoDiv.appendChild(link);

          const networkDiv = document.createElement('div');
          networkDiv.className = 'source-network';
          networkDiv.textContent = source.Network;
          infoDiv.appendChild(networkDiv);

          header.appendChild(infoDiv);
          tile.appendChild(header);

          const statsDiv = document.createElement('div');
          statsDiv.className = 'source-stats';

          const stat1 = document.createElement('div');
          stat1.className = 'source-stat';
          const val1 = document.createElement('span');
          val1.className = 'source-stat-value formatted-metric';
          val1.textContent = Number(source.TotalInteractions).toLocaleString();
          stat1.appendChild(val1);
          const label1 = document.createElement('span');
          label1.className = 'source-stat-label';
          label1.textContent = 'Interactions';
          stat1.appendChild(label1);
          statsDiv.appendChild(stat1);

          const stat2 = document.createElement('div');
          stat2.className = 'source-stat source-stat-right';
          const val2 = document.createElement('span');
          val2.className = 'source-stat-value formatted-metric';
          val2.textContent = Number(source.FollowersCount).toLocaleString();
          stat2.appendChild(val2);
          const label2 = document.createElement('span');
          label2.className = 'source-stat-label';
          label2.textContent = 'Followers';
          stat2.appendChild(label2);
          statsDiv.appendChild(stat2);

          tile.appendChild(statsDiv);

          grid.appendChild(tile);

          if (placeholder) {
            placeholder.style.backgroundColor = networkColor;
          }
        });

      })
      .catch(err => {
        console.error("Error loading sources:", err);
        btn.disabled = false;
        btn.innerHTML = originalContent;
        alert("Failed to load more sources.");
      });
  }
</script>