{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
  <div>
    <h1>Dashboard</h1>
    <p class="text-muted">Welcome back, <b style="text-transform: capitalize">{{.username}}</b>!</p>
  </div>

  <div class="flex gap-2">
    <form method="GET" action="/">
      <button class="btn btn-secondary btn-icon" title="Refresh Page">
        <i data-lucide="refresh-cw"></i>
      </button>
    </form>
  </div>
</div>

<div class="grid-dashboard">

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="server" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_sources}}</div>
    <div class="stat-label">Active Sources</div>
    <a href="/sources" class="stat-link">Manage Sources &rarr;</a>
  </div>


  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="database" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.active_targets}}</div>
    <div class="stat-label">Active Targets</div>
    <a href="/targets" class="stat-link">Manage Targets &rarr;</a>
  </div>

  <div class="stat-card {{if gt .sync_errors_30d 0}}has-errors{{end}}">
    <div class="stat-icon"><i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value">{{.sync_errors_30d}}</div>
    <div class="stat-label">Sync Errors (30d)</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="file-text" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_posts}}</div>
    <div class="stat-label">Total Posts Tracked</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="heart" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_likes}}</div>
    <div class="stat-label">Total Likes</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="share-2" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_shares}}</div>
    <div class="stat-label">Total Shares/Reposts</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="eye" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_views}}</div>
    <div class="stat-label">Total Post Views</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="users" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_visitors}}</div>
    <div class="stat-label">Website Visitors</div>
  </div>

  <div class="stat-card">
    <div class="stat-icon"><i data-lucide="mouse-pointer" style="width: 24px; height: 24px;"></i></div>
    <div class="stat-value formatted-metric">{{.total_page_views}}</div>
    <div class="stat-label">Website Page Views</div>
  </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">Engagement Over Time</div>
  <div style="position: relative; height: 400px; width: 100%;">
    <canvas id="engagementChart"></canvas>
  </div>
</div>

<div class="card">
  <div class="card-header">Recent Sync Errors</div>
  {{if not .recent_logs}}
  <div class="text-center" style="padding: 2rem; color: var(--color-text-muted);">
    <i data-lucide="check-circle" style="width: 48px; height: 48px; opacity: 0.5; color: var(--color-success);"></i>
    <p>No recent errors found.</p>
  </div>
  {{else}}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
      <thead>
        <tr style="text-align: left; border-bottom: 1px solid var(--color-border);">
          <th style="padding: 0.75rem;">Time</th>
          <th style="padding: 0.75rem;">Source/Target</th>
          <th style="padding: 0.75rem;">Message</th>
        </tr>
      </thead>
      <tbody>
        {{range .recent_logs}}
        <tr style="border-bottom: 1px solid var(--color-border);">
          <td style="padding: 0.75rem; white-space: nowrap; color: var(--color-text-muted);">
            {{.CreatedAt.Format "Jan 02 15:04"}}
          </td>
          <td style="padding: 0.75rem;">
            {{if .SourceNetwork.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">{{.SourceNetwork.String}}</span>
              <span>{{.SourceUsername.String}}</span>
            </div>
            {{else if .TargetType.Valid}}
            <div class="flex items-center gap-2">
              <span class="badge badge-neutral">Target</span>
              <span>{{.TargetType.String}}</span>
            </div>
            {{else}}
            <span class="text-muted">System</span>
            {{end}}
          </td>
          <td style="padding: 0.75rem; color: var(--color-danger);">
            {{.Message}}
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>

{{ template "footer.html" . }}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const metrics = document.querySelectorAll('.formatted-metric');
    metrics.forEach(el => {
      let val = parseInt(el.textContent.trim());
      if (isNaN(val)) return;

      if (val >= 100000) {
        let shortened = (val / 1000).toFixed(1);
        if (shortened.endsWith('.0')) {
          shortened = shortened.slice(0, -2);
        }
        el.textContent = shortened + 'k';
      } else if (val >= 1000) {
        el.textContent = val.toLocaleString();
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch('/stats')
      .then(response => response.json())
      .then(data => {
        if (!data || data.length === 0) {
          return;
        }

        const ctx = document.getElementById('engagementChart').getContext('2d');

        const datasets = [];
        const allDates = new Set();

        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#333';

        data.forEach(source => {
          const points = source.points || [];
          const dataPoints = points.map(p => {
            const dateStr = p.date;
            allDates.add(dateStr);
            return {
              x: dateStr,
              y: p.likes + p.reposts
            };
          });

          let hash = 0;
          const str = source.network + source.username;
          for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
          }
          const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
          const color = '#' + "00000".substring(0, 6 - c.length) + c;

          datasets.push({
            label: `${source.network} (${source.username})`,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3
          });
        });

        const sortedDates = Array.from(allDates).sort();

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'category',
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Total Engagement' },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(20, 20, 30, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                padding: 10,
                cornerRadius: 8,
                displayColors: true
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching stats:", err));
  });
</script>