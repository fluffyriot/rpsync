<!DOCTYPE html>
<html>

<head>
  <title>Service Status</title>

  <link rel="stylesheet" href="/static/css/index.css">
</head>

<body>

  <div class="container">
    <h1>Setup Status</h1>

    <p>Username: <span class="ok">{{.username}}</span></p>
    <p>User Id: <span class="ok">{{.user_id}}</span></p>

    <div class="card">
      <div class="card-header">Sync Sources</div>

      <ul class="source-list">
        {{range .sources}}
        <li class="source-item">

          <div class="source-main">
            <strong>{{.UserName}}</strong>
            <span class="source-network">{{.Network}}</span>
          </div>

          <div class="source-meta">
            <span class="sync-status
  {{if eq .SyncStatus " Initialized"}}status-initialized{{end}} {{if eq .SyncStatus "Syncing" }}status-syncing{{end}}
              {{if eq .SyncStatus "Synced" }}status-synced{{end}} {{if eq .SyncStatus "Failed" }}status-failed{{end}}
              {{if not .IsActive}}status-disabled{{end}}">

              {{if not .IsActive}}
              Disabled
              {{else}}
              {{.SyncStatus}}
              {{end}}

              {{if .StatusReason.Valid}}
              <span class="tooltip">
                â“˜
                <span class="tooltip-text">
                  {{.StatusReason.String}}
                </span>
              </span>
              {{end}}
            </span>


            <span class="last-sync">
              {{if .LastSynced.Valid}}
              Last sync: {{.LastSynced.Time.Format "2006-01-02 15:04"}}
              {{else}}
              Last sync: never
              {{end}}
            </span>
          </div>

          <div class="source-actions">

            <form method="POST" action="/sources/sync" style="display:inline;"
              onsubmit="return submitWithConfirm(this);">
              <input type="hidden" name="source_id" value="{{.ID}}">
              <button type="submit" class="sync" {{if not .IsActive}}disabled{{end}}>Sync</button>
            </form>

            {{if .IsActive}}
            <form method="POST" action="/sources/deactivate" style="display:inline;"
              onsubmit="return submitWithConfirm(this, 'Deactivate this source?');">
              <input type="hidden" name="source_id" value="{{.ID}}">
              <button type="submit" class="fail">Deactivate</button>
            </form>
            {{else}}
            <form method="POST" action="/sources/activate" style="display:inline;"
              onsubmit="return submitWithConfirm(this);">
              <input type="hidden" name="source_id" value="{{.ID}}">
              <button type="submit" class="ok">Activate</button>
            </form>
            {{end}}

            <form method="POST" action="/sources/delete" style="display:inline;"
              onsubmit="return submitWithConfirm(this, 'Delete this source?');">
              <input type="hidden" name="source_id" value="{{.ID}}">
              <button type="submit" class="fail">Delete</button>
            </form>

          </div>

        </li>
        {{end}}

        {{if not .sources}}
        <p class="fail">No active sources yet.</p>
        {{end}}
      </ul>
    </div>

    <div class="form-section inline-form">
      <form method="POST" action="/sources/setup" id="source_form">
        <input type="hidden" name="user_id" value="{{.user_id}}">
        <select id="network" name="network" required>
          <option value="" disabled selected>Select Network</option>
          <option value="Bluesky">Bluesky</option>
          <option value="Instagram">Instagram</option>
          <option value="Murrtube">Murrtube</option>
          <option value="BadPups">BadPups</option>
        </select>
        <input type="text" name="username" placeholder="Username" required>
        <label for="api_token" id="api_token_label" style="display:none;">API Token</label>
        <input id="api_token" name="api_token" type="password" placeholder="Add your API token" style="display:none;">
        <button type="submit">Add Source</button>
      </form>

      <div class="form-section inline-form button-group">

         <form method="GET" action="/">
          <button type="submit" class="refresh">Refresh</button>
        </form>

        <form method="POST" action="/sources/syncAll" style="display:inline;"
              onsubmit="return submitWithConfirm(this);">
              <input type="hidden" name="user_id" value="{{.user_id}}">
              <button type="submit" class="refresh">Sync All Sources</button>
            </form>
        
        <form method="GET" action="/exports">
        <button type="submit" class="sync">Exports</button>
      </form>

        <form method="POST" action="/reset" style="display:inline;"
          onclick="return submitWithConfirm(this, 'Are you sure you want to reset the configuration? Everything will be deleted and this action cannot be undone.');">
          <button type="submit" class="fail">Reset Configuration</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("source_form");
      const networkSelect = document.getElementById("network");
      const tokenInput = document.getElementById("api_token");
      const tokenLabel = document.getElementById("api_token_label");

      if (!form || !networkSelect || !tokenInput || !tokenLabel) return;

      function updateTokenVisibility() {
        if (networkSelect.value === "Instagram") {
          tokenInput.style.display = "block";
          tokenLabel.style.display = "block";
          tokenInput.required = true;
        } else {
          tokenInput.style.display = "none";
          tokenLabel.style.display = "none";
          tokenInput.required = false;
          tokenInput.value = "";
        }
      }

      networkSelect.addEventListener("change", updateTokenVisibility);

      form.addEventListener("submit", function (e) {
        if (networkSelect.value === "Instagram" && tokenInput.value.trim() === "") {
          e.preventDefault();
          alert("Instagram requires an API token.");
          tokenInput.focus();
        }
      });
    });


  </script>

  <script>
    function submitWithConfirm(form, message) {
      if (message && !window.confirm(message)) {
        return false;
      }

      fetch(form.action, {
        method: form.method,
        body: new FormData(form)
      })
        .then(res => {
          if (res.ok) {
            window.location.reload();
          } else {
            alert("Operation failed");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Error performing operation");
        });

      return false;
    }
  </script>

</body>

</html>