{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <div>
        <h1>Sync Settings</h1>
    </div>
</div>

<div class="card">
    <div class="card-header">Syncer Configuration</div>

    <form method="POST" action="/settings/sync" style="padding: 1.5rem;">

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="sync_period" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Sync
                Period</label>
            <select name="sync_period" id="sync_period" class="form-select" style="width: 100%; max-width: 300px;">
                <option value="15m" {{if eq .sync_period "15m" }}selected{{end}}>15 minutes</option>
                <option value="30m" {{if eq .sync_period "30m" }}selected{{end}}>30 minutes</option>
                <option value="1h" {{if eq .sync_period "1h" }}selected{{end}}>1 hour</option>
                <option value="6h" {{if eq .sync_period "6h" }}selected{{end}}>6 hours</option>
                <option value="12h" {{if eq .sync_period "12h" }}selected{{end}}>12 hours</option>
                <option value="24h" {{if eq .sync_period "24h" }}selected{{end}}>24 hours</option>
            </select>
            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">How often the worker should
                automatically sync all sources and targets</p>
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="enabled_on_startup" id="enabled_on_startup" {{if
                    .enabled_on_startup}}checked{{end}} style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500;">Enable worker on startup</span>
            </label>
            <p class="text-muted" style="margin-top: 0.5rem; margin-left: 1.625rem; font-size: 0.875rem;">
                When enabled, the worker will automatically start when the application launches
            </p>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary"
                onclick="return submitWithConfirm(this, 'System will turn on or restart the worker with your new settings. Do you want to continue?');">
                <i data-lucide="save"></i> Save Settings
            </button>
        </div>
    </form>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">Manual Control</div>

    <div style="padding: 1.5rem;">
        <p class="text-muted" style="margin-bottom: 1rem;">
            Manually control the background worker or reset to default settings.
        </p>

        <div class="flex gap-2 mobile-equal-width" style="flex-wrap: wrap;">
            <form method="POST" action="/settings/sync/reset"
                onsubmit="return submitWithConfirm(this, 'Reset to default settings (30m interval, enabled on startup)?');">
                <button type="submit" class="btn btn-secondary">
                    <i data-lucide="rotate-ccw"></i> Reset to Defaults
                </button>
            </form>

            {{ if .worker_running }}
            <form method="POST" action="/settings/sync/stop"
                onsubmit="return submitWithConfirm(this, 'Stop the background worker?');">
                <button type="submit" class="btn btn-danger">
                    <i data-lucide="square"></i> Stop Worker
                </button>
            </form>
            {{ else }}
            <form method="POST" action="/settings/sync/start">
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="play"></i> Start Worker
                </button>
            </form>
            {{ end }}

            <form method="POST" action="/syncAll"
                onsubmit="return submitWithConfirm(this, 'Do you want to start a full import/export sync now?');">
                <input type="hidden" name="user_id" value="{{.user_id}}">
                <button type="submit" class="btn btn-primary" title="Manual Sync">
                    <i data-lucide="cloud-sync"></i> Manual Sync
                </button>
            </form>

        </div>
    </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">Post Exclusions</div>

    <div style="padding: 1.5rem;">
        <p class="text-muted" style="margin-bottom: 1rem;">
            Exclude specific posts from being synced. Excluded posts will be permanently deleted from the database and
            will not be re-synced in future fetches.
        </p>

        <div class="exclusion-controls">
            <button type="button" class="btn btn-primary" onclick="showAddExclusionModal()">
                <i data-lucide="plus"></i> Add Exclusion
            </button>

            <div class="exclusion-search-container">
                <input type="text" id="exclusionSearch" class="form-select" placeholder="Search by ID...">
            </div>
        </div>

        <div id="exclusions-list">
            <p class="text-muted exclusion-list-empty">Loading exclusions...</p>
        </div>

        <div id="pagination-controls" class="pagination-controls" style="display: none;">
            <button id="prevBtn" class="btn btn-secondary btn-icon" onclick="changePage(-1)" disabled
                title="Previous Page">
                <i data-lucide="chevron-left"></i>
            </button>
            <span id="pageInfo" class="text-muted" style="font-weight: 500;">Page 1 of 1</span>
            <button id="nextBtn" class="btn btn-secondary btn-icon" onclick="changePage(1)" disabled title="Next Page">
                <i data-lucide="chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">Page Redirects</div>

    <div style="padding: 1.5rem;">
        <p class="text-muted" style="margin-bottom: 1rem;">
            Configure page path redirects. Stats for the "From Path" will be merged into the "To Path".
        </p>

        <div class="exclusion-controls">
            <button type="button" class="btn btn-primary" onclick="showAddRedirectModal()">
                <i data-lucide="plus"></i> Add Redirect
            </button>

            <div class="exclusion-search-container">
                <input type="text" id="redirectSearch" class="form-select" placeholder="Search by Path...">
            </div>
        </div>

        <div id="redirects-list">
            <p class="text-muted exclusion-list-empty">Loading redirects...</p>
        </div>

        <div id="redirect-pagination-controls" class="pagination-controls" style="display: none;">
            <button id="prevRedirectBtn" class="btn btn-secondary btn-icon" onclick="changeRedirectPage(-1)" disabled
                title="Previous Page">
                <i data-lucide="chevron-left"></i>
            </button>
            <span id="redirectPageInfo" class="text-muted" style="font-weight: 500;">Page 1 of 1</span>
            <button id="nextRedirectBtn" class="btn btn-secondary btn-icon" onclick="changeRedirectPage(1)" disabled
                title="Next Page">
                <i data-lucide="chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div id="addExclusionModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px; margin: 2rem;">
        <div class="card-header">Add Post Exclusion</div>
        <div style="padding: 1.5rem;">
            <form id="addExclusionForm" onsubmit="handleAddExclusion(event)">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="exclusion_source_id"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Source</label>
                    <select name="source_id" id="exclusion_source_id" class="form-select" required style="width: 100%;">
                        <option value="">Select a source...</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="exclusion_network_id"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Network Internal ID(s)</label>
                    <input type="text" name="network_internal_id" id="exclusion_network_id" class="form-select" required
                        style="width: 100%;" placeholder="e.g., post ID, shortcode, or comma-separated list...">
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">One or more platform-specific
                        IDs to exclude</p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i> Add Exclusion
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddExclusionModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="addRedirectModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px; margin: 2rem;">
        <div class="card-header">Add Page Redirect</div>
        <div style="padding: 1.5rem;">
            <form id="addRedirectForm" onsubmit="handleAddRedirect(event)">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="redirect_source_id"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Source</label>
                    <select name="source_id" id="redirect_source_id" class="form-select" required style="width: 100%;">
                        <option value="">Select a source...</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="redirect_from_path"
                        style="display: block; margin-bottom: 0.5rem; font-weight: 500;">From Path</label>
                    <input type="text" name="from_path" id="redirect_from_path" class="form-select" required
                        style="width: 100%;" placeholder="e.g. /old-page">
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="redirect_to_path" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">To
                        Path</label>
                    <input type="text" name="to_path" id="redirect_to_path" class="form-select" required
                        style="width: 100%;" placeholder="e.g. /new-page">
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">
                        Note: Stats will be merged. This action deletes the old path stats.
                    </p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i> Add Redirect
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddRedirectModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let allSources = [];
    let allExclusions = [];
    let filteredExclusions = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    let allRedirects = [];
    let filteredRedirects = [];
    let currentRedirectPage = 1;

    async function loadSources() {
        try {
            const response = await fetch('/api/sources');
            if (!response.ok) throw new Error('Failed to load sources');
            allSources = await response.json();

            const select = document.getElementById('exclusion_source_id');
            const redirectSelect = document.getElementById('redirect_source_id');

            select.innerHTML = '<option value="">Select a source...</option>';
            redirectSelect.innerHTML = '<option value="">Select a source...</option>';

            let exclusionCount = 0;
            let redirectCount = 0;
            let lastExclusionId = "";
            let lastRedirectId = "";

            allSources.forEach(source => {
                if (source.Network !== 'Google Analytics') {
                    const option = document.createElement('option');
                    option.value = source.ID;
                    option.textContent = `${source.Network} - ${source.UserName}`;
                    select.appendChild(option);
                    exclusionCount++;
                    lastExclusionId = source.ID;
                }

                if (source.Network === 'Google Analytics') {
                    const option = document.createElement('option');
                    option.value = source.ID;
                    option.textContent = `${source.Network} - ${source.UserName}`;
                    redirectSelect.appendChild(option);
                    redirectCount++;
                    lastRedirectId = source.ID;
                }
            });

            if (exclusionCount === 1) {
                select.value = lastExclusionId;
            }
            if (redirectCount === 1) {
                redirectSelect.value = lastRedirectId;
            }

            loadExclusions();
            loadRedirects();

        } catch (error) {
            console.error('Error loading sources:', error);
        }
    }

    async function loadExclusions() {
        try {
            const response = await fetch('/api/exclusions');
            if (!response.ok) throw new Error('Failed to load exclusions');

            allExclusions = await response.json();
            applyFilters();
        } catch (error) {
            console.error('Error loading exclusions:', error);
            document.getElementById('exclusions-list').innerHTML = '<p class="exclusion-list-error">Error loading exclusions</p>';
        }
    }

    async function loadRedirects() {
        try {
            allRedirects = [];
            for (const source of allSources) {
                const response = await fetch(`/api/redirects?source_id=${source.ID}`);
                if (response.ok) {
                    const data = await response.json();
                    allRedirects = allRedirects.concat(data);
                }
            }
            applyRedirectFilters();

        } catch (error) {
            console.error('Error loading redirects:', error);
            document.getElementById('redirects-list').innerHTML = '<p class="exclusion-list-error">Error loading redirects</p>';
        }
    }

    function applyFilters() {
        const query = document.getElementById('exclusionSearch').value.toLowerCase();

        if (query) {
            filteredExclusions = allExclusions.filter(excl =>
                excl.network_internal_id.toLowerCase().includes(query)
            );
        } else {
            filteredExclusions = [...allExclusions];
        }

        currentPage = 1;
        renderExclusions();
    }

    function applyRedirectFilters() {
        const query = document.getElementById('redirectSearch').value.toLowerCase();

        if (query) {
            filteredRedirects = allRedirects.filter(r =>
                r.from_path.toLowerCase().includes(query) || r.to_path.toLowerCase().includes(query)
            );
        } else {
            filteredRedirects = [...allRedirects];
        }

        currentRedirectPage = 1;
        renderRedirects();
    }

    function renderExclusions() {
        const container = document.getElementById('exclusions-list');
        const paginationContainer = document.getElementById('pagination-controls');

        if (filteredExclusions.length === 0) {
            container.innerHTML = '<p class="text-muted exclusion-list-empty">No exclusions found</p>';
            paginationContainer.style.display = 'none';
            return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredExclusions.slice(startIndex, endIndex);

        container.innerHTML = pageItems.map(excl => `
            <div class="card exclusion-item">
                <div>
                    <strong>${excl.network_internal_id}</strong><br>
                    <span class="text-muted" style="font-size: 0.875rem;">${excl.network} - ${excl.user_name}</span>
                </div>
                <button class="btn btn-danger exclusion-delete-btn" onclick="deleteExclusion('${excl.id}')">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        `).join('');

        renderPagination();
        lucide.createIcons();
    }

    function renderRedirects() {
        const container = document.getElementById('redirects-list');
        const paginationContainer = document.getElementById('redirect-pagination-controls');

        if (filteredRedirects.length === 0) {
            container.innerHTML = '<p class="text-muted exclusion-list-empty">No redirects found</p>';
            paginationContainer.style.display = 'none';
            return;
        }

        const startIndex = (currentRedirectPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredRedirects.slice(startIndex, endIndex);

        container.innerHTML = pageItems.map(r => `
            <div class="card exclusion-item">
                <div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <strong>${r.from_path}</strong>
                        <i data-lucide="arrow-right" style="width: 16px;"></i>
                        <strong>${r.to_path}</strong>
                    </div>
                    <span class="text-muted" style="font-size: 0.875rem;">${r.network} - ${r.user_name}</span>
                </div>
                <button class="btn btn-danger exclusion-delete-btn" onclick="deleteRedirect('${r.id}')">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        `).join('');

        renderRedirectPagination();
        lucide.createIcons();
    }


    function renderPagination() {
        const paginationContainer = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(filteredExclusions.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }

        paginationContainer.style.display = 'flex';

        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function renderRedirectPagination() {
        const paginationContainer = document.getElementById('redirect-pagination-controls');
        const totalPages = Math.ceil(filteredRedirects.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }

        paginationContainer.style.display = 'flex';

        document.getElementById('redirectPageInfo').textContent = `Page ${currentRedirectPage} of ${totalPages}`;
        document.getElementById('prevRedirectBtn').disabled = currentRedirectPage === 1;
        document.getElementById('nextRedirectBtn').disabled = currentRedirectPage === totalPages;
    }

    function changePage(delta) {
        currentPage += delta;
        renderExclusions();
    }

    function changeRedirectPage(delta) {
        currentRedirectPage += delta;
        renderRedirects();
    }

    function showAddExclusionModal() {
        document.getElementById('addExclusionModal').style.display = 'flex';
    }

    function hideAddExclusionModal() {
        document.getElementById('addExclusionModal').style.display = 'none';
        document.getElementById('addExclusionForm').reset();
    }

    function showAddRedirectModal() {
        document.getElementById('addRedirectModal').style.display = 'flex';
    }

    function hideAddRedirectModal() {
        document.getElementById('addRedirectModal').style.display = 'none';
        document.getElementById('addRedirectForm').reset();
    }

    async function handleAddExclusion(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            source_id: formData.get('source_id'),
            network_internal_id: formData.get('network_internal_id')
        };

        try {
            const response = await fetch('/api/exclusions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add exclusion');
            }

            hideAddExclusionModal();
            await loadExclusions();
            alert('Exclusion added successfully! The post has been deleted from the database.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function handleAddRedirect(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            source_id: formData.get('source_id'),
            from_path: formData.get('from_path'),
            to_path: formData.get('to_path')
        };

        // Basic validation
        if (data.from_path === data.to_path) {
            alert("From and To paths must be different.");
            return;
        }

        try {
            const response = await fetch('/api/redirects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add redirect');
            }

            hideAddRedirectModal();
            await loadRedirects();
            alert('Redirect added successfully! Stats merging started in background.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function deleteExclusion(id) {
        if (!confirm('Are you sure you want to delete this exclusion? The post may be re-synced in future fetches.')) {
            return;
        }

        try {
            const response = await fetch(`/api/exclusions/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete exclusion');
            }

            await loadExclusions();
            alert('Exclusion deleted successfully');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function deleteRedirect(id) {
        if (!confirm('Are you sure you want to delete this redirect? This will trigger a Safe Restore (stats will be cleared and re-fetched from GA).')) {
            return;
        }

        try {
            const response = await fetch(`/api/redirects/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete redirect');
            }

            await loadRedirects();
            alert('Redirect deleted successfully! Safe restore started in background.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSources();

        const searchInput = document.getElementById('exclusionSearch');
        searchInput.addEventListener('input', () => {
            applyFilters();
        });

        const redirectSearchInput = document.getElementById('redirectSearch');
        redirectSearchInput.addEventListener('input', () => {
            applyRedirectFilters();
        });
    });
</script>

{{ template "footer.html" . }}