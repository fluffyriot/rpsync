{{ template "header.html" . }}

<div class="flex justify-between items-center mb-4">
    <div>
        <h1>Sync Settings</h1>
    </div>
</div>

<div class="grid-responsive">
    <div>
        <div class="card">
            <div class="card-header">Sections</div>
            <nav class="settings-nav">
                <a href="#user-settings" class="settings-nav-item active" data-section="user-settings">
                    <i data-lucide="user"></i> User Settings
                </a>
                <a href="#account-security" class="settings-nav-item" data-section="account-security">
                    <i data-lucide="shield"></i> Account Security
                </a>
                <a href="#server-config" class="settings-nav-item" data-section="server-config">
                    <i data-lucide="server"></i> Server Configuration
                </a>
                <a href="#syncer-config" class="settings-nav-item" data-section="syncer-config">
                    <i data-lucide="settings"></i> Syncer Configuration
                </a>
                <a href="#manual-control" class="settings-nav-item" data-section="manual-control">
                    <i data-lucide="sliders"></i> Manual Control
                </a>
                <a href="#post-exclusions" class="settings-nav-item" data-section="post-exclusions">
                    <i data-lucide="file-x"></i> Post Exclusions
                </a>
                <a href="#page-redirects" class="settings-nav-item" data-section="page-redirects">
                    <i data-lucide="corner-down-right"></i> Page Redirects
                </a>
            </nav>
        </div>
    </div>

    <div>
        <div id="user-settings" class="card settings-section">
            <div class="card-header">User Settings</div>

            <div class="flex flex-col gap-4">
                <div class="flex items-center gap-4 flex-wrap">
                    <div id="avatar-container">
                        {{ if .has_avatar }}
                        <img id="settings-avatar-preview" src="/user/{{ .user_id }}/avatar?v={{.avatar_version}}"
                            alt="Avatar" class="settings-avatar settings-avatar-preview">
                        {{ else }}
                        <div id="settings-avatar-placeholder"
                            class="profile-initial settings-avatar settings-avatar-placeholder">
                            {{ .username_initial }}
                        </div>
                        {{ end }}
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="btn btn-secondary cursor-pointer">
                            <i data-lucide="upload"></i> Upload Avatar
                            <input type="file" id="avatar-upload" accept="image/*" style="display: none;"
                                onchange="handleAvatarUpload(this)">
                        </label>
                        <button class="btn btn-ghost" onclick="handleRemoveAvatar()" {{ if not .has_avatar
                            }}style="display: none;" {{ end }} id="remove-avatar-btn">
                            <i data-lucide="trash-2"></i> Remove Avatar
                        </button>
                    </div>
                </div>

                <form onsubmit="handleUsernameUpdate(event)" class="mt-4">
                    <div class="form-group">
                        <label for="username_input" class="form-label-bold">Username</label>
                        <div class="flex gap-2">
                            <input type="text" id="username_input" name="username" class="form-input"
                                value="{{ .username }}" required style="margin-bottom: 0;" autocapitalize="off">
                            <button type="submit" class="btn btn-primary"><i data-lucide="save"></i> Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="account-security" class="card settings-section" style="margin-top: 1.5rem;">
            <div class="card-header">Account Security</div>
            <div>
                <p class="text-muted mb-4">
                    Manage your account security settings.
                </p>
                <div class="flex gap-2 flex-wrap">
                    {{ if .is_2fa_enabled }}
                    <button class="btn btn-secondary" disabled
                        style="opacity: 1; cursor: default; border-color: var(--color-success);">
                        <i data-lucide="check-circle" style="color: var(--color-success)"></i> 2FA Enabled
                    </button>
                    {{ else }}
                    <a href="/settings/2fa/setup" class="btn btn-primary">
                        <i data-lucide="shield-check"></i> Setup Two-Factor Authentication
                    </a>
                    {{ end }}

                    <button class="btn btn-primary" onclick="showUpdatePasswordModal()">
                        <i data-lucide="lock"></i> Update Password
                    </button>

                    <div class="inline-relative">
                        {{ if .is_passkey_supported }}
                        <button class="btn btn-secondary" onclick="registerPasskey()">
                            <i data-lucide="key"></i> Register Passkey
                        </button>
                        {{ else }}
                        <button class="btn btn-secondary" disabled
                            title="{{ if not .is_secure_context }}Passkeys require HTTPS connection{{ else }}Passkeys require a domain name (not an IP address){{ end }}">
                            <i data-lucide="key"></i> Register Passkey (Unavailable)
                        </button>
                        {{ end }}
                    </div>

                </div>
            </div>
        </div>

        <div id="server-config" class="card settings-section">
            <div class="card-header">Server Configuration</div>

            <form method="POST" action="/settings/server">
                <div class="form-group mb-md">
                    <label class="checkbox-label">
                        <input type="checkbox" name="allow_new_user_creation" id="allow_new_user_creation" {{if
                            .allow_new_user_creation}}checked{{end}} class="checkbox-input">
                        <span style="font-weight: 500;">Allow new user creation</span>
                    </label>
                    <p class="text-muted helper-text indent">
                        If disabled, new users cannot register from login page.
                    </p>
                </div>

                <div class="form-group mb-md">
                    <label class="checkbox-label">
                        <input type="checkbox" name="enabled_on_startup" id="enabled_on_startup" {{if
                            .enable_worker_on_startup}}checked{{end}} class="checkbox-input">
                        <span style="font-weight: 500;">Enable worker on startup</span>
                    </label>
                    <p class="text-muted helper-text indent">
                        When enabled, the worker will automatically start when the application launches.
                    </p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i> Save Server Settings
                    </button>
                </div>
            </form>
        </div>

        <div id="syncer-config" class="card settings-section" style="margin-top: 1.5rem;">
            <div class="card-header">Syncer Configuration</div>

            <form method="POST" action="/settings/sync">

                <div class="form-group mb-md">
                    <label for="sync_period" class="form-label-bold">Sync
                        Period</label>
                    <select name="sync_period" id="sync_period" class="form-select mw-300">
                        <option value="15m" {{if eq .sync_period "15m" }}selected{{end}}>15 minutes</option>
                        <option value="30m" {{if eq .sync_period "30m" }}selected{{end}}>30 minutes</option>
                        <option value="1h" {{if eq .sync_period "1h" }}selected{{end}}>1 hour</option>
                        <option value="6h" {{if eq .sync_period "6h" }}selected{{end}}>6 hours</option>
                        <option value="12h" {{if eq .sync_period "12h" }}selected{{end}}>12 hours</option>
                        <option value="24h" {{if eq .sync_period "24h" }}selected{{end}}>24 hours</option>
                    </select>
                    <p class="text-muted helper-text">How often the worker should
                        automatically sync all sources and targets</p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary"
                        onclick="return submitWithConfirm(this, 'System will turn on or restart the worker with your new settings. Do you want to continue?');">
                        <i data-lucide="save"></i> Save Settings
                    </button>

                    <form method="POST" action="/settings/sync/reset"
                        onsubmit="return submitWithConfirm(this, 'Reset to default settings (30m interval)?');">
                        <button type="submit" class="btn btn-secondary">
                            <i data-lucide="rotate-ccw"></i> Reset to Defaults
                        </button>
                    </form>
                </div>
            </form>
        </div>

        <div id="manual-control" class="card settings-section" style="margin-top: 1.5rem;">
            <div class="card-header">Manual Control</div>

            <div>
                <p class="text-muted" style="margin-bottom: 1rem;">
                    Manually control the background worker and a syncronizer.
                </p>

                <div class="flex gap-2 mobile-equal-width flex-wrap">
                    <form method="POST" action="/syncAll"
                        onsubmit="return submitWithConfirm(this, 'Do you want to start a full import/export sync now?');">
                        <input type="hidden" name="user_id" value="{{.user_id}}">
                        <button type="submit" class="btn btn-primary" title="Manual Sync">
                            <i data-lucide="cloud-sync"></i> Manual Sync
                        </button>
                    </form>

                    {{ if .worker_running }}
                    <form method="POST" action="/settings/sync/stop"
                        onsubmit="return submitWithConfirm(this, 'Stop the background worker?');">
                        <button type="submit" class="btn btn-danger">
                            <i data-lucide="square"></i> Stop Worker
                        </button>
                    </form>
                    {{ else }}
                    <form method="POST" action="/settings/sync/start">
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="play"></i> Start Worker
                        </button>
                    </form>
                    {{ end }}

                </div>
            </div>
        </div>

        <div id="post-exclusions" class="card settings-section" style="margin-top: 1.5rem;">
            <div class="card-header">Post Exclusions</div>

            <div>
                <p class="text-muted" style="margin-bottom: 1rem;">
                    Exclude specific posts from being synced. Excluded posts will be permanently deleted from the
                    database and will not be re-synced in future fetches.
                </p>

                <div class="exclusion-controls">
                    <button type="button" class="btn btn-primary" onclick="showAddExclusionModal()">
                        <i data-lucide="plus"></i> Add Exclusion
                    </button>

                    <div class="exclusion-search-container">
                        <input type="text" id="exclusionSearch" class="form-select" placeholder="Search by ID..."
                            autocapitalize="off">
                    </div>
                </div>

                <div id="exclusions-list">
                    <p class="text-muted exclusion-list-empty">Loading exclusions...</p>
                </div>

                <div id="pagination-controls" class="pagination-controls hidden">
                    <button id="prevBtn" class="btn btn-secondary btn-icon" onclick="changePage(-1)" disabled
                        title="Previous Page">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <span id="pageInfo" class="text-muted" style="font-weight: 500;">Page 1 of 1</span>
                    <button id="nextBtn" class="btn btn-secondary btn-icon" onclick="changePage(1)" disabled
                        title="Next Page">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="page-redirects" class="card settings-section" style="margin-top: 1.5rem;">
            <div class="card-header">Page Redirects</div>

            <div>
                <p class="text-muted" style="margin-bottom: 1rem;">
                    Configure page path redirects. Stats for the "From Path" will be merged into the "To Path".
                </p>

                <div class="exclusion-controls">
                    <button type="button" class="btn btn-primary" onclick="showAddRedirectModal()">
                        <i data-lucide="plus"></i> Add Redirect
                    </button>

                    <div class="exclusion-search-container">
                        <input type="text" id="redirectSearch" class="form-select" placeholder="Search by Path..."
                            autocapitalize="off">
                    </div>
                </div>

                <div id="redirects-list">
                    <p class="text-muted exclusion-list-empty">Loading redirects...</p>
                </div>

                <div id="redirect-pagination-controls" class="pagination-controls hidden">
                    <button id="prevRedirectBtn" class="btn btn-secondary btn-icon" onclick="changeRedirectPage(-1)"
                        disabled title="Previous Page">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <span id="redirectPageInfo" class="text-muted" style="font-weight: 500;">Page 1 of 1</span>
                    <button id="nextRedirectBtn" class="btn btn-secondary btn-icon" onclick="changeRedirectPage(1)"
                        disabled title="Next Page">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addExclusionModal" class="modal-overlay">
    <div class="card modal-card">
        <div class="card-header">Add Post Exclusion</div>
        <div>
            <form id="addExclusionForm" onsubmit="handleAddExclusion(event)">
                <div class="form-group mb-sm">
                    <label for="exclusion_source_id" class="form-label-bold">Source</label>
                    <select name="source_id" id="exclusion_source_id" class="form-select w-full" required>
                        <option value="">Select a source...</option>
                    </select>
                </div>

                <div class="form-group mb-md">
                    <label for="exclusion_network_id" class="form-label-bold">Network Internal ID(s)</label>
                    <input type="text" name="network_internal_id" id="exclusion_network_id" class="form-select w-full"
                        required placeholder="e.g., post ID, shortcode, or comma-separated list..."
                        autocapitalize="off">
                    <p class="text-muted helper-text">One or more platform-specific
                        IDs to exclude</p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i> Add Exclusion
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddExclusionModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="addRedirectModal" class="modal-overlay">
    <div class="card modal-card">
        <div class="card-header">Add Page Redirect</div>
        <div>
            <form id="addRedirectForm" onsubmit="handleAddRedirect(event)">
                <div class="form-group mb-sm">
                    <label for="redirect_source_id" class="form-label-bold">Source</label>
                    <select name="source_id" id="redirect_source_id" class="form-select w-full" required>
                        <option value="">Select a source...</option>
                    </select>
                </div>

                <div class="form-group mb-sm">
                    <label for="redirect_from_path" class="form-label-bold">From Path</label>
                    <input type="text" name="from_path" id="redirect_from_path" class="form-select w-full" required
                        placeholder="e.g. /old-page" autocapitalize="off">
                </div>

                <div class="form-group mb-md">
                    <label for="redirect_to_path" class="form-label-bold">To
                        Path</label>
                    <input type="text" name="to_path" id="redirect_to_path" class="form-select w-full" required
                        placeholder="e.g. /new-page" autocapitalize="off">
                    <p class="text-muted helper-text">
                        Note: Stats will be merged. This action deletes the old path stats.
                    </p>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i> Add Redirect
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddRedirectModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.settings-nav-item');
        const sections = document.querySelectorAll('.settings-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();

                navItems.forEach(nav => nav.classList.remove('active'));

                item.classList.add('active');
                const sectionId = item.getAttribute('data-section');
                const section = document.getElementById(sectionId);

                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -70% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const sectionId = entry.target.id;
                    navItems.forEach(nav => {
                        if (nav.getAttribute('data-section') === sectionId) {
                            navItems.forEach(n => n.classList.remove('active'));
                            nav.classList.add('active');
                        }
                    });
                }
            });
        }, observerOptions);

        sections.forEach(section => observer.observe(section));

        lucide.createIcons();
    });
</script>

<script>
    let allSources = [];
    let allExclusions = [];
    let filteredExclusions = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    let allRedirects = [];
    let filteredRedirects = [];
    let currentRedirectPage = 1;

    async function loadSources() {
        try {
            const response = await fetch('/api/sources');
            if (!response.ok) throw new Error('Failed to load sources');
            allSources = await response.json();

            const select = document.getElementById('exclusion_source_id');
            const redirectSelect = document.getElementById('redirect_source_id');

            select.innerHTML = '<option value="">Select a source...</option>';
            redirectSelect.innerHTML = '<option value="">Select a source...</option>';

            let exclusionCount = 0;
            let redirectCount = 0;
            let lastExclusionId = "";
            let lastRedirectId = "";

            allSources.forEach(source => {
                if (source.Network !== 'Google Analytics') {
                    const option = document.createElement('option');
                    option.value = source.ID;
                    option.textContent = `${source.Network} - ${source.UserName}`;
                    select.appendChild(option);
                    exclusionCount++;
                    lastExclusionId = source.ID;
                }

                if (source.Network === 'Google Analytics') {
                    const option = document.createElement('option');
                    option.value = source.ID;
                    option.textContent = `${source.Network} - ${source.UserName}`;
                    redirectSelect.appendChild(option);
                    redirectCount++;
                    lastRedirectId = source.ID;
                }
            });

            if (exclusionCount === 1) {
                select.value = lastExclusionId;
            }
            if (redirectCount === 1) {
                redirectSelect.value = lastRedirectId;
            }

            loadExclusions();
            loadRedirects();

        } catch (error) {
            console.error('Error loading sources:', error);
        }
    }

    async function loadExclusions() {
        try {
            const response = await fetch('/api/exclusions');
            if (!response.ok) throw new Error('Failed to load exclusions');

            allExclusions = await response.json();
            applyFilters();
        } catch (error) {
            console.error('Error loading exclusions:', error);
            document.getElementById('exclusions-list').innerHTML = '<p class="exclusion-list-error">Error loading exclusions</p>';
        }
    }

    async function loadRedirects() {
        try {
            allRedirects = [];
            for (const source of allSources) {
                const response = await fetch(`/api/redirects?source_id=${source.ID}`);
                if (response.ok) {
                    const data = await response.json();
                    allRedirects = allRedirects.concat(data);
                }
            }
            applyRedirectFilters();

        } catch (error) {
            console.error('Error loading redirects:', error);
            document.getElementById('redirects-list').innerHTML = '<p class="exclusion-list-error">Error loading redirects</p>';
        }
    }

    function applyFilters() {
        const query = document.getElementById('exclusionSearch').value.toLowerCase();

        if (query) {
            filteredExclusions = allExclusions.filter(excl =>
                excl.network_internal_id.toLowerCase().includes(query)
            );
        } else {
            filteredExclusions = [...allExclusions];
        }

        currentPage = 1;
        renderExclusions();
    }

    function applyRedirectFilters() {
        const query = document.getElementById('redirectSearch').value.toLowerCase();

        if (query) {
            filteredRedirects = allRedirects.filter(r =>
                r.from_path.toLowerCase().includes(query) || r.to_path.toLowerCase().includes(query)
            );
        } else {
            filteredRedirects = [...allRedirects];
        }

        currentRedirectPage = 1;
        renderRedirects();
    }

    function renderExclusions() {
        const container = document.getElementById('exclusions-list');
        const paginationContainer = document.getElementById('pagination-controls');

        if (filteredExclusions.length === 0) {
            container.innerHTML = '<p class="text-muted exclusion-list-empty">No exclusions found</p>';
            paginationContainer.style.display = 'none';
            return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredExclusions.slice(startIndex, endIndex);

        container.innerHTML = pageItems.map(excl => `
            <div class="card exclusion-item">
                <div>
                    <strong>${excl.network_internal_id}</strong><br>
                    <span class="text-muted" style="font-size: 0.875rem;">${excl.network} - ${excl.user_name}</span>
                </div>
                <button class="btn btn-danger btn-icon" onclick="deleteExclusion('${excl.id}')" title="Delete">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        `).join('');

        renderPagination();
        lucide.createIcons();
    }

    function renderRedirects() {
        const container = document.getElementById('redirects-list');
        const paginationContainer = document.getElementById('redirect-pagination-controls');

        if (filteredRedirects.length === 0) {
            container.innerHTML = '<p class="text-muted exclusion-list-empty">No redirects found</p>';
            paginationContainer.style.display = 'none';
            return;
        }

        const startIndex = (currentRedirectPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredRedirects.slice(startIndex, endIndex);

        container.innerHTML = pageItems.map(r => `
            <div class="card exclusion-item">
                <div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <strong>${r.from_path}</strong>
                        <i data-lucide="arrow-right" style="width: 16px;"></i>
                        <strong>${r.to_path}</strong>
                    </div>
                    <span class="text-muted" style="font-size: 0.875rem;">${r.network} - ${r.user_name}</span>
                </div>
                <button class="btn btn-danger btn-icon" onclick="deleteRedirect('${r.id}')" title="Delete">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        `).join('');

        renderRedirectPagination();
        lucide.createIcons();
    }


    function renderPagination() {
        const paginationContainer = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(filteredExclusions.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }

        paginationContainer.style.display = 'flex';

        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function renderRedirectPagination() {
        const paginationContainer = document.getElementById('redirect-pagination-controls');
        const totalPages = Math.ceil(filteredRedirects.length / itemsPerPage);

        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }

        paginationContainer.style.display = 'flex';

        document.getElementById('redirectPageInfo').textContent = `Page ${currentRedirectPage} of ${totalPages}`;
        document.getElementById('prevRedirectBtn').disabled = currentRedirectPage === 1;
        document.getElementById('nextRedirectBtn').disabled = currentRedirectPage === totalPages;
    }

    function changePage(delta) {
        currentPage += delta;
        renderExclusions();
    }

    function changeRedirectPage(delta) {
        currentRedirectPage += delta;
        renderRedirects();
    }

    function showAddExclusionModal() {
        document.getElementById('addExclusionModal').style.display = 'flex';
    }

    function hideAddExclusionModal() {
        document.getElementById('addExclusionModal').style.display = 'none';
        document.getElementById('addExclusionForm').reset();
    }

    function showAddRedirectModal() {
        document.getElementById('addRedirectModal').style.display = 'flex';
    }

    function hideAddRedirectModal() {
        document.getElementById('addRedirectModal').style.display = 'none';
        document.getElementById('addRedirectForm').reset();
    }

    async function handleAddExclusion(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            source_id: formData.get('source_id'),
            network_internal_id: formData.get('network_internal_id')
        };

        try {
            const response = await fetch('/api/exclusions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add exclusion');
            }

            hideAddExclusionModal();
            await loadExclusions();
            alert('Exclusion added successfully! The post has been deleted from the database.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function handleAddRedirect(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            source_id: formData.get('source_id'),
            from_path: formData.get('from_path'),
            to_path: formData.get('to_path')
        };

        // Basic validation
        if (data.from_path === data.to_path) {
            alert("From and To paths must be different.");
            return;
        }

        try {
            const response = await fetch('/api/redirects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add redirect');
            }

            hideAddRedirectModal();
            await loadRedirects();
            alert('Redirect added successfully! Stats merging started in background.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function deleteExclusion(id) {
        if (!confirm('Are you sure you want to delete this exclusion? The post may be re-synced in future fetches.')) {
            return;
        }

        try {
            const response = await fetch(`/api/exclusions/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete exclusion');
            }

            await loadExclusions();
            alert('Exclusion deleted successfully');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function deleteRedirect(id) {
        if (!confirm('Are you sure you want to delete this redirect? This will trigger a Safe Restore (stats will be cleared and re-fetched from GA).')) {
            return;
        }

        try {
            const response = await fetch(`/api/redirects/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete redirect');
            }

            await loadRedirects();
            alert('Redirect deleted successfully! Safe restore started in background.');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSources();

        const searchInput = document.getElementById('exclusionSearch');
        searchInput.addEventListener('input', () => {
            applyFilters();
        });

        const redirectSearchInput = document.getElementById('redirectSearch');
        if (redirectSearchInput) {
            redirectSearchInput.addEventListener('input', () => {
                applyRedirectFilters();
            });
        }
    });

    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
    }

    async function registerPasskey() {
        try {
            const beginResp = await fetch('/settings/passkey/register/begin', {
                method: 'POST'
            });
            if (!beginResp.ok) {
                const err = await beginResp.json();
                throw new Error(err.error || 'Failed to start registration');
            }
            const options = await beginResp.json();

            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            options.publicKey.user.id = bufferDecode(options.publicKey.user.id);
            if (options.publicKey.excludeCredentials) {
                for (let cred of options.publicKey.excludeCredentials) {
                    cred.id = bufferDecode(cred.id);
                }
            }

            const credential = await navigator.credentials.create({
                publicKey: options.publicKey
            });
            const response = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferEncode(credential.response.attestationObject),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                },
            };

            const finishResp = await fetch('/settings/passkey/register/finish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(response),
            });

            if (!finishResp.ok) {
                const err = await finishResp.json();
                throw new Error(err.error || 'Failed to finish registration');
            }

            alert("Passkey registered successfully!");

        } catch (e) {
            console.error(e);
            alert("Error registering passkey: " + e.message);
        }
    }

    async function handleUsernameUpdate(event) {
        event.preventDefault();
        const username = document.getElementById('username_input').value;
        const formData = new FormData();
        formData.append('username', username);

        try {
            const response = await fetch('/settings/user/update', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                alert('Username updated successfully');
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to update username'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function handleAvatarUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const response = await fetch('/settings/user/avatar/upload', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to upload avatar'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function handleRemoveAvatar() {
        if (!confirm("Are you sure you want to remove your profile avatar?")) return;
        try {
            const response = await fetch('/settings/user/avatar/remove', {
                method: 'POST'
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to remove avatar'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

</script>

<div id="updatePasswordModal" class="modal-overlay">
    <div class="card modal-card">
        <div class="card-header">Update Password</div>
        <div>
            <form id="updatePasswordForm" onsubmit="handleUpdatePassword(event)">
                <div class="form-group mb-sm">
                    <label class="form-label-bold">Current
                        Password</label>
                    <input class="form-select w-full" type="password" name="current_password" required
                        autocomplete="current-password">
                </div>
                <div class="form-group mb-sm">
                    <label class="form-label-bold">New
                        Password</label>
                    <input class="form-select w-full" type="password" name="new_password" id="update_new_password"
                        required autocomplete="new-password">
                    <ul id="password-requirements" class="text-muted password-requirements">
                        <li id="req-len" class="text-danger">Min 8 characters</li>
                        <li id="req-upper" class="text-danger">Uppercase letter</li>
                        <li id="req-lower" class="text-danger">Lowercase letter</li>
                        <li id="req-num" class="text-danger">Number</li>
                        <li id="req-spec" class="text-danger">Special character</li>
                    </ul>
                </div>
                <div class="form-group mb-md">
                    <label class="form-label-bold">Confirm
                        Password</label>
                    <input class="form-select w-full" type="password" name="confirm_password"
                        id="update_confirm_password" required autocomplete="new-password">
                    <p id="match-error" class="text-danger match-error">Passwords do not match</p>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary" id="update-password-submit-btn" disabled>
                        <i data-lucide="save"></i> Update Password
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideUpdatePasswordModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const newPassInput = document.getElementById('update_new_password');
        const confirmPassInput = document.getElementById('update_confirm_password');
        if (newPassInput && confirmPassInput) {
            newPassInput.addEventListener('input', validatePasswordUpdate);
            confirmPassInput.addEventListener('input', validatePasswordUpdate);
        }
    });

    function showUpdatePasswordModal() {
        document.getElementById('updatePasswordModal').style.display = 'flex';
    }

    function hideUpdatePasswordModal() {
        document.getElementById('updatePasswordModal').style.display = 'none';
        document.getElementById('updatePasswordForm').reset();
        document.querySelectorAll('#password-requirements li').forEach(li => {
            li.classList.remove('text-success');
            li.classList.add('text-danger');
        });
        document.getElementById('match-error').style.display = 'none';
        document.getElementById('update-password-submit-btn').disabled = true;
    }

    const msgReqs = {
        len: val => val.length >= 8,
        upper: val => /[A-Z]/.test(val),
        lower: val => /[a-z]/.test(val),
        num: val => /[0-9]/.test(val),
        spec: val => /[!@#$%^&*(),.?":{}|<>\-=_+[\]\/\\';`~]/.test(val)
    };

    function validatePasswordUpdate() {
        const newPass = document.getElementById('update_new_password').value;
        const confirmPass = document.getElementById('update_confirm_password').value;
        const submitBtn = document.getElementById('update-password-submit-btn');
        const matchError = document.getElementById('match-error');

        let allValid = true;

        for (const [key, check] of Object.entries(msgReqs)) {
            const isValid = check(newPass);
            const li = document.getElementById(`req-${key}`);
            if (isValid) {
                li.classList.remove('text-danger');
                li.classList.add('text-success');
            } else {
                li.classList.remove('text-success');
                li.classList.add('text-danger');
                allValid = false;
            }
        }

        const match = newPass === confirmPass && newPass !== "";
        if (confirmPass.length > 0) {
            if (match) {
                matchError.style.display = 'none';
            } else {
                matchError.style.display = 'block';
                allValid = false;
            }
        } else {
            matchError.style.display = 'none';
        }

        if (!match && confirmPass.length > 0) allValid = false;
        if (newPass === "" || confirmPass === "") allValid = false;

        submitBtn.disabled = !allValid;
    }

    async function handleUpdatePassword(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        try {
            const response = await fetch('/settings/user/password', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                hideUpdatePasswordModal();
            } else {
                alert("Error: " + result.error);
            }
        } catch (error) {
            alert("Request failed: " + error.message);
        }
    }
</script>

{{ template "footer.html" . }}